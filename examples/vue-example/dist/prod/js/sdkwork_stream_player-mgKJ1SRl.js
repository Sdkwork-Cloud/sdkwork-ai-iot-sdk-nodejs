import{aF as t,aG as e,aH as s,aI as i,aJ as r,aK as a}from"./index-BkXo8abR.js";class n{player=null;state=t.IDLE;volume=1;emitter=e();autoplayStatus=s.UNKNOWN;pendingPlayPromise=null;pendingPlayResolve=null;pendingPlayReject=null;config;constructor(t){this.config={decode:!1,sampleRate:16e3,realtime:!1,maxDelay:800,discardAll:!1,trafficImgUrl:"",channels:1,...t},this.initPlayer(),this.detectAutoplaySupport(),i.getInstance().onStatusChange(r.AUDIO,this.handleAutoplayStatusChange.bind(this))}initPlayer(){if(a.BufferStreamPlayer)try{a.TrafficImgUrl=this.config.trafficImgUrl,this.player=a.BufferStreamPlayer({decode:this.config.decode,sampleRate:this.config.sampleRate,realtime:this.config.realtime,maxDelay:this.config.maxDelay,discardAll:this.config.discardAll,TrafficImgUrl:this.config.trafficImgUrl,onInputError:(t,e)=>{this.emitter.emit("onError",new Error(`音频片段输入出错: ${t}`))},onPlayEnd:()=>{this.setState(t.ENDED),this.emitter.emit("onEnd",null)}})}catch(e){this.emitter.emit("onError",e instanceof Error?e:new Error(String(e)))}}async detectAutoplaySupport(t=!1){const e=await i.getInstance().detectMediaSupport(r.AUDIO,t);return this.autoplayStatus=e.status,e}async requestAutoplayPermission(t=!1){const e=await i.getInstance().requestPermission(r.AUDIO,t);return this.autoplayStatus=e.status,e}handleAutoplayStatusChange(t){this.autoplayStatus=t.status,this.emitter.emit("onAutoplayStatusChange",t)}async startStream(e,i){if(void 0!==e&&(this.config.sampleRate=e),void 0!==i&&(this.config.channels=i),!this.player&&(this.initPlayer(),!this.player))throw new Error("流式音频播放器初始化失败");return this.state!==t.IDLE&&this.state!==t.ERROR&&await this.stopStream(),this.autoplayStatus===s.UNKNOWN&&await this.detectAutoplaySupport(),new Promise((e,i)=>{try{if(this.autoplayStatus===s.ALLOWED)this.player.start(()=>{this.setState(t.READY),this.emitter.emit("onPlay",null),e()},e=>{this.setState(t.ERROR),this.emitter.emit("onError",new Error(e)),i(new Error(e))});else if(this.autoplayStatus===s.ALLOWED_MUTED){const s=this.volume;this.setVolume(0),this.player.start(()=>{this.setState(t.READY),this.emitter.emit("onPlay",null);const i=()=>{this.setVolume(s),document.removeEventListener("click",i),document.removeEventListener("touchstart",i),document.removeEventListener("keydown",i)};document.addEventListener("click",i),document.addEventListener("touchstart",i),document.addEventListener("keydown",i),e()},e=>{this.setState(t.ERROR),this.emitter.emit("onError",new Error(e)),i(new Error(e))})}else{const s={status:this.autoplayStatus,requiresUserInteraction:!0,requiresMuted:!1};this.setState(t.WAITING_FOR_INTERACTION),this.emitter.emit("onAutoplayBlocked",s),this.pendingPlayPromise=new Promise((t,e)=>{this.pendingPlayResolve=t,this.pendingPlayReject=e});const r=e,a=i;this.pendingPlayPromise.then(()=>{r()}).catch(t=>{a(t)})}}catch(r){this.setState(t.ERROR),this.emitter.emit("onError",r instanceof Error?r:new Error(String(r))),i(r)}})}async resumeAfterInteraction(){try{if(!this.player)throw new Error("流式音频播放器未初始化");if(this.state!==t.WAITING_FOR_INTERACTION)throw new Error("播放器不在等待用户交互状态");this.player.start(()=>{this.setState(t.READY),this.emitter.emit("onPlay",null),this.pendingPlayResolve&&(this.pendingPlayResolve(),this.pendingPlayPromise=null,this.pendingPlayResolve=null,this.pendingPlayReject=null),this.detectAutoplaySupport(!0)},e=>{this.setState(t.ERROR),this.emitter.emit("onError",new Error(e)),this.pendingPlayReject&&(this.pendingPlayReject(new Error(e)),this.pendingPlayPromise=null,this.pendingPlayResolve=null,this.pendingPlayReject=null)})}catch(e){throw this.setState(t.ERROR),this.emitter.emit("onError",e instanceof Error?e:new Error(String(e))),this.pendingPlayReject&&(this.pendingPlayReject(e instanceof Error?e:new Error(String(e))),this.pendingPlayPromise=null,this.pendingPlayResolve=null,this.pendingPlayReject=null),e}}appendStreamData(e){if(this.player&&(this.state===t.READY||this.state===t.PLAYING||this.state===t.PAUSED))try{if(e instanceof Float32Array){const t=new Int16Array(e.length);for(let s=0;s<e.length;s++)t[s]=Math.max(-32768,Math.min(32767,Math.round(32767*e[s])));this.player.input(t)}else e instanceof Int16Array?this.player.input(e):e instanceof ArrayBuffer&&this.player.input(new Int16Array(e));this.state!==t.PLAYING&&this.setState(t.PLAYING)}catch(s){this.emitter.emit("onError",s instanceof Error?s:new Error(String(s)))}}async stopStream(){if(this.player)try{this.state!==t.IDLE&&this.state!==t.ERROR&&(this.player.stop&&this.player.stop(),this.setState(t.IDLE),this.emitter.emit("onStop",null))}catch(e){this.emitter.emit("onError",e instanceof Error?e:new Error(String(e)))}}pause(e){if(this.player&&(this.state===t.READY||this.state===t.PLAYING||this.state===t.PAUSED))try{this.player.pause&&(this.player.pause(),this.setState(t.PAUSED),this.emitter.emit("onPause",null)),e&&this.clearInput()}catch(s){this.emitter.emit("onError",s instanceof Error?s:new Error(String(s)))}}clearInput(e){this.player&&(this.state!==t.READY&&this.state!==t.PLAYING&&this.state!==t.PAUSED||this.player.clearInput(e))}async resume(){if(this.player&&(this.state===t.READY||this.state===t.PLAYING||this.state===t.PAUSED))try{this.player.resume&&(this.player.resume(),this.setState(t.PLAYING),this.emitter.emit("onPlay",null))}catch(e){this.emitter.emit("onError",e instanceof Error?e:new Error(String(e)))}}stop(){this.stopStream()}setVolume(t){this.volume=Math.max(0,Math.min(1,t)),this.player&&this.player.setVolume&&(this.player.setVolume(this.volume),this.emitter.emit("onVolumeChange",this.volume))}getVolume(){return this.volume}getState(){return this.state}isPlayable(){return this.state===t.READY||this.state===t.PLAYING||this.state===t.PAUSED}isRestartable(){return this.state===t.PLAYING||this.state===t.READY||this.state===t.PAUSED}setState(t){if(this.state!==t){const e=this.state;this.state=t,this.emitter.emit("onStateChange",{oldState:e,newState:t})}}on(t,e){this.emitter.on(t,e)}off(t){this.emitter.off(t)}destroy(){try{this.stopStream(),this.player&&this.player.destroy&&this.player.destroy(),this.player=null,this.emitter.all.clear(),this.setState(t.IDLE)}catch(e){}}}export{n as S};
