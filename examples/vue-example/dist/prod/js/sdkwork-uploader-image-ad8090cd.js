import{k as e,r as a,w as t,c as l,Q as s,R as o,S as i,X as n,F as r,Y as d,a1 as u,j as p,u as c,U as m,V as g,$ as v,a4 as f,t as h,a8 as w,n as y}from"./vue-vendor-a2672387.js";import{v as b,a as k,_ as x}from"./index-5affcab4.js";const U={class:"sdkwork-uploader-image"},C={class:"upload-content"},I=["src","alt"],$=["onClick"],L={class:"image-overlay"},B={key:0,class:"upload-progress"},R={class:"progress-bar"},P={class:"progress-text"},j={key:1,class:"status-icons"},V={key:0,class:"success-icon"},M={key:1,class:"error-icon"},T={class:"action-buttons"},z=["onClick"],D={key:1,class:"button-group"},F=["onClick"],G=["onClick"],O={class:"upload-icon"},_={class:"upload-text"},S={class:"upload-title"},A={class:"upload-subtitle"},E=["disabled"],W={key:1,class:"prompt-section"},q={class:"prompt-input-wrapper"},H=["placeholder","maxlength"],J={class:"prompt-footer"},K={class:"footer-left"},N=["disabled"],Q={class:"prompt-count"},X={key:0,class:"ai-generate-section"},Y=["disabled"],Z=x(e({__name:"sdkwork-uploader-image",props:{modelValue:{default:()=>[]},accept:{default:"image/*"},multiple:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},autoUpload:{type:Boolean,default:!0},maxSize:{default:10485760},maxCount:{default:10},maxWidth:{default:1920},maxHeight:{default:1080},quality:{default:.8},title:{default:"点击或拖拽图片到此处"},subtitle:{default:"支持 JPG、PNG、GIF、WEBP 等格式"},bucket:{default:void 0},scene:{default:"image"},metadata:{default:()=>({})},contentType:{default:"image/jpeg"},acl:{default:"private"},showPrompt:{type:Boolean,default:!1},aiGenerate:{type:Boolean,default:!1},promptPlaceholder:{default:"描述您想要生成的图片内容、风格和细节..."},aiGenerateText:{default:"AI生成"},promptValue:{default:""},promptMaxLength:{default:200},showRegenerate:{type:Boolean,default:!1},regenerateText:{default:"重新生成"},removeButtonPosition:{default:"always-visible"}},emits:["update:modelValue","upload-start","upload-progress","upload-success","upload-error","upload-complete","image-add","image-remove","image-clear","image-preview","update:prompt","ai-generate","image-ai-generate","regenerate-image"],setup(e,{expose:x,emit:Z}){const ee=e,ae=Z;a();const te=a(!1),{isDarkMode:le}=b(),se=a(ee.promptValue||"");t(()=>ee.promptValue,e=>{e!==se.value&&(se.value=e||"")});const oe=a([]),ie=l(()=>oe.value.filter(e=>"uploading"===e.status).length),ne=l(()=>0===ee.maxCount||oe.value.length<ee.maxCount),re=l(()=>ee.multiple?oe.value:oe.value.slice(0,1));t(()=>ee.modelValue,async e=>{if(e&&e.length>0){const a=oe.value.map(e=>e.id),t=await Promise.all(e.filter(e=>!a.includes(de(e))).map(e=>ue(e)));oe.value=[...oe.value,...t],ee.autoUpload&&y(()=>{we()})}},{immediate:!0});const de=e=>`${e.name}-${e.size}-${e.lastModified}`,ue=async e=>{const a=await(e=>new Promise(a=>{a(URL.createObjectURL(e))}))(e),t=await(e=>new Promise(a=>{const t=new Image,l=URL.createObjectURL(e);t.onload=()=>{a({width:t.width,height:t.height}),URL.revokeObjectURL(l)},t.onerror=()=>{a({width:0,height:0}),URL.revokeObjectURL(l)},t.src=l}))(e);return{id:de(e),file:e,name:e.name,size:e.size,previewUrl:a,dimensions:t,status:"pending",progress:0}},pe=async()=>{if(!ee.disabled&&ne.value)try{const e=await window.$files.chooseImage({count:ee.multiple?ee.maxCount:1,success:e=>{console.log("图片选择成功:",e)},fail:e=>{console.error("图片选择失败:",e)},complete:()=>{console.log("图片选择完成")}});e.tempFiles&&e.tempFiles.length>0&&await ve(e.tempFiles)}catch(e){console.error("图片选择异常:",e)}},ce=e=>{e.preventDefault(),!ee.disabled&&ne.value&&(te.value=!0)},me=e=>{e.preventDefault(),te.value=!1},ge=async e=>{e.preventDefault(),te.value=!1,!ee.disabled&&ne.value&&e.dataTransfer?.files&&await ve(Array.from(e.dataTransfer.files))},ve=async e=>{if(0===e.length)return;const a=e.filter(e=>e.type.startsWith("image/"));if(0===a.length)return void window.$message?.warning("请选择图片文件");const t=0===ee.maxCount?1/0:ee.maxCount-oe.value.length,l=a.slice(0,t);if(0===l.length)return void window.$message?.warning(`最多只能上传 ${ee.maxCount} 张图片`);const s=[],o=[];for(const r of l)r.size>ee.maxSize?o.push(r):s.push(r);if(o.length>0&&window.$message?.error(`以下图片超过最大限制 ${(e=>{if(0===e)return"0 B";const a=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,a)).toFixed(2))+" "+["B","KB","MB","GB"][a]})(ee.maxSize)}: ${o.map(e=>e.name).join(", ")}`),0===s.length)return;const i=await Promise.all(s.map(e=>ue(e)));oe.value=[...oe.value,...i];const n=oe.value.map(e=>e.file);ae("update:modelValue",n),ae("image-add",s),i.forEach(e=>{ae("image-preview",e.file,e.previewUrl)}),ee.autoUpload&&we()},fe=e=>{const a=oe.value.findIndex(a=>a.id===e);if(-1!==a){const e=oe.value[a];"uploading"===e.status&&e.uploadId&&window.$uploader?.cancel(e.uploadId),URL.revokeObjectURL(e.previewUrl),oe.value.splice(a,1);const t=oe.value.map(e=>e.file);ae("update:modelValue",t),ae("image-remove",e.file)}},he=()=>{oe.value.forEach(e=>{"uploading"===e.status&&e.uploadId&&window.$uploader?.cancel(e.uploadId),URL.revokeObjectURL(e.previewUrl)}),oe.value=[],ae("update:modelValue",[]),ae("image-clear")},we=async()=>{const e=oe.value.filter(e=>"pending"===e.status);if(0!==e.length){for(const a of e)await ye(a);ae("upload-complete",oe.value.map(e=>e.file))}},ye=async e=>{if(window.$uploader){e.status="uploading",e.progress=0,ae("upload-start",e.file);try{const a={file:e.file,bucket:ee.bucket||{name:"default-bucket"},name:e.name,scene:ee.scene,metadata:ee.metadata,contentType:ee.contentType||"image/jpeg",acl:ee.acl},t=await window.$uploader.upload(a,a=>{e.progress=a.percentage,ae("upload-progress",e.file,a.percentage)});e.status="success",e.progress=100,ae("upload-success",e.file,t)}catch(a){e.status="error",ae("upload-error",e.file,a),console.error("Upload failed:",a)}}else console.error("Uploader not available")},be=()=>{ae("update:prompt",se.value)},ke=()=>{se.value&&se.value.trim().length>0&&ae("ai-generate",se.value.trim())},xe=()=>{oe.value.length>0&&ae("image-ai-generate",oe.value)};return x({clearImages:()=>{he()},uploadImages:()=>{we()},getImageList:()=>oe.value.map(e=>({file:e.file,previewUrl:e.previewUrl,dimensions:e.dimensions,status:e.status,progress:e.progress,response:"success"===e.status?"uploaded":void 0}))}),(a,t)=>(s(),o("div",U,[i("div",{class:n(["upload-area",{"drag-over":te.value,disabled:e.disabled,"has-images":oe.value.length>0,"dark-mode":c(le)}]),onClick:pe,onDrop:ge,onDragover:ce,onDragleave:me},[i("div",C,[oe.value.length>0?(s(),o("div",{key:0,class:n(["image-previews",{"single-image":1===oe.value.length}])},[(s(!0),o(r,null,d(re.value,(a,t)=>(s(),o("div",{key:a.id,class:n(["image-preview",{uploading:"uploading"===a.status,success:"success"===a.status,error:"error"===a.status}])},[i("img",{src:a.previewUrl,alt:a.name,class:"preview-img"},null,8,I),"always-visible"===e.removeButtonPosition&&"uploading"!==a.status?(s(),o("div",{key:0,class:"remove-btn-always",onClick:u(e=>fe(a.id),["stop"])},[p(c(k),{icon:"material-symbols:close",width:"14",height:"14"})],8,$)):m("",!0),i("div",L,["uploading"===a.status?(s(),o("div",B,[i("div",R,[i("div",{class:"progress-fill",style:g({width:a.progress+"%"})},null,4)]),i("span",P,v(a.progress)+"%",1)])):(s(),o("div",j,["success"===a.status?(s(),o("span",V,"✓")):m("",!0),"error"===a.status?(s(),o("span",M,"✗")):m("",!0)])),i("div",T,["uploading"===a.status?(s(),o("button",{key:0,type:"button",class:"cancel-btn",onClick:u(e=>(e=>{const a=oe.value.find(a=>a.id===e);a&&a.uploadId&&(window.$uploader?.cancel(a.uploadId),a.status="pending",a.progress=0,a.uploadId=void 0)})(a.id),["stop"])}," 取消 ",8,z)):(s(),o("div",D,[e.showRegenerate&&"success"===a.status?(s(),o("button",{key:0,type:"button",class:"regenerate-btn",onClick:u(e=>(e=>{const a=se.value||"";a.trim().length>0&&ae("regenerate-image",e,a.trim())})(a),["stop"])},[p(c(k),{icon:"material-symbols:replay",width:"12",height:"12"}),f(" "+v(e.regenerateText),1)],8,F)):m("",!0),"overlay"===e.removeButtonPosition?(s(),o("button",{key:1,type:"button",class:"remove-btn",onClick:u(e=>fe(a.id),["stop"])}," 移除 ",8,G)):m("",!0)]))])])],2))),128)),ne.value?(s(),o("div",{key:0,class:n(["add-more-btn",{"dark-mode":c(le)}]),onClick:pe},[...t[1]||(t[1]=[i("div",{class:"add-icon"},"+",-1),i("div",{class:"add-text"},"添加图片",-1)])],2)):m("",!0)],2)):(s(),o("div",{key:1,class:n(["empty-state",{"dark-mode":c(le)}])},[i("div",O,[p(c(k),{icon:"material-symbols:image",width:"48",height:"48"})]),i("div",_,[i("p",S,v(e.title),1),i("p",A,v(e.subtitle),1)])],2))])],34),oe.value.length>0&&!e.autoUpload?(s(),o("div",{key:0,class:n(["upload-actions",{"dark-mode":c(le)}])},[i("button",{type:"button",class:n(["upload-btn primary",{"dark-mode":c(le)}]),disabled:ie.value>0,onClick:we},v(ie.value>0?`上传中... (${ie.value})`:"开始上传"),11,E),i("button",{type:"button",class:n(["upload-btn secondary",{"dark-mode":c(le)}]),onClick:he}," 取消 ",2)],2)):m("",!0),e.showPrompt?(s(),o("div",W,[i("div",q,[h(i("textarea",{"onUpdate:modelValue":t[0]||(t[0]=e=>se.value=e),placeholder:e.promptPlaceholder,maxlength:e.promptMaxLength,class:n(["prompt-input",{"dark-mode":c(le)}]),rows:"3",onInput:be},null,42,H),[[w,se.value]]),i("div",J,[i("div",K,[i("button",{type:"button",class:n(["ai-generate-btn prompt-generate icon-only",{"dark-mode":c(le)}]),onClick:ke,disabled:!se.value||0===se.value.trim().length,title:"文字AI生成"},[p(c(k),{icon:"material-symbols:auto-awesome",width:"16",height:"16"})],10,N)]),i("span",Q,v(se.value?.length||0)+"/"+v(e.promptMaxLength),1)])]),e.aiGenerate?(s(),o("div",X,[i("button",{type:"button",class:n(["ai-generate-btn image-generate",{"dark-mode":c(le)}]),onClick:xe,disabled:0===oe.value.length},[p(c(k),{icon:"material-symbols:auto-awesome",width:"16",height:"16"}),f(" "+v(oe.value.length>0?"重新生成图片":"生成图片"),1)],10,Y)])):m("",!0)])):m("",!0)]))}}),[["__scopeId","data-v-cff39ac0"]]);export{Z as _};
