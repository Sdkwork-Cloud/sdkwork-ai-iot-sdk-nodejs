const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/iot-handler-pZ7oexFx.js","js/index-3Iq02xX1.js","js/vue-vendor-BOogp7Xw.js","js/utils-vendor-WEzSe-CR.js","css/index-D4l5L7TK.css","js/conversation-DqcFaGCt.js","js/sdkwork_stream_player-BhVVFyuh.js","js/sse-handler-4-8cobXb.js","js/im-handler-D-yfV81H.js"])))=>i.map(i=>d[i]);
import{z as e}from"./vue-vendor-BOogp7Xw.js";import{x as t,M as a,y as s,k as r,j as o,h as n,aD as i,aE as c,aF as l,g as d}from"./index-3Iq02xX1.js";import{u as h}from"./conversation-DqcFaGCt.js";import{S as g}from"./sdkwork_stream_player-BhVVFyuh.js";class m extends t.BaseService{constructor(){super(a.create(s.ChatMessageManager))}async loadMore(e,t,a){const s=await this.manager.loadMore(e,t,a);return null==s||null==s.data?Promise.reject(new Error("data error!")):s.data}}var u=(e=>(e.SENDING="sending",e.SENT="sent",e.FAILED="failed",e.DELIVERED="delivered",e))(u||{});const y=e("message",{state:()=>({loading:!1,error:null,initialized:!1,messages:[],currentPage:1,pageSize:20,hasMore:!0,totalCount:0,streaming:!1,currentStream:null,toolCalls:[],toolResults:[]}),getters:{isLoading:e=>e.loading,getError:e=>e.error,isInitialized:e=>e.initialized,currentMessages:e=>e.messages,messageCount:e=>e.messages.length,lastMessage:e=>e.messages[e.messages.length-1]||null,isStreaming:e=>e.streaming,hasActiveToolCalls:e=>e.toolCalls.length>0,sortedMessages:e=>[...e.messages].sort((e,t)=>(e.sendAt?window.$date.parse(e.sendAt).getTime():0)-(t.sendAt?window.$date.parse(t.sendAt).getTime():0)),unreadCount:e=>e.messages.filter(e=>!e.readAt).length,sendingMessages:e=>e.messages.filter(e=>e.metadata?.get?.("sendStatus")===u.SENDING),failedMessages:e=>e.messages.filter(e=>e.metadata?.get?.("sendStatus")===u.FAILED),getCurrentPage:e=>e.currentPage,getPageSize:e=>e.pageSize,getHasMore:e=>e.hasMore,getTotalCount:e=>e.totalCount},actions:{async initialize(){try{this.loading=!0,this.initialized=!0}catch(e){throw this.error=e,e}finally{this.loading=!1}},async loadMessages(e){try{this.loading=!0;const t=new m,a={},s=h().currentConversation;s?(s.id&&(a.conversationId=s.id),s.uuid&&(a.conversationUuid=s.uuid)):a.conversationId=e.conversationId,void 0!==e.page&&(a.page=e.page),void 0!==e.size&&(a.size=e.size);const r=await t.listByPage(a);this.messages=r.content||[]}catch(t){throw this.error=t,t}finally{this.loading=!1}},async loadMoreMessages(e){try{this.loading=!0;const t=new m,a={},s=h().currentConversation;if(s?(s.id&&(a.conversationId=s.id),s.uuid&&(a.conversationUuid=s.uuid)):a.conversationId=e.conversationId,e.lastSyncMessageId)a.lastSyncMessageId=e.lastSyncMessageId;else if(this.messages.length>0){const e=this.messages[0];e&&e.id&&(a.lastSyncMessageId=e.id)}void 0!==e.page&&(a.page=e.page),void 0!==e.size&&(a.size=e.size);const r=await t.loadMore(a);this.messages=[...this.messages,...r.content||[]]}catch(t){throw this.error=t,t}finally{this.loading=!1}},async saveMessage(e,t){const a=r.messageToVO(e);this.saveMessageVO(a,t)},async saveMessageVO(e,t){try{this.loading=!0,e.uuid||(e.uuid=window.$uuid()),e.sendAt||(e.sendAt=window.$date.format(new Date));const a=n().currentUser;return e.sender&&e.senderId||a&&(!e.senderId&&a.id&&(e.senderId=a.id),e.sender||(e.sender={id:a.id,name:a.nickname||a.username,uuid:a.uuid})),this.setMessageSendStatus(e,u.SENDING),t&&(e.metadata=e.metadata||new Map,e.metadata.set("chatContext",t)),e.senderId&&e.senderId===a?.id&&(e.isOwn=!0),this.messages.push(e),console.error("message========================",e),window.dispatchEvent(new CustomEvent("sdk:messageSent",{detail:{type:"GENERIC_MESSAGE_SENT",message:e,chatContext:t}})),e}catch(a){throw this.error=a,a}finally{this.loading=!1}},handleReceivedMessage(e){const t={id:e.id,content:e.content,role:o.MessageRole.ASSISTANT,isOwn:!1,timestamp:e.timestamp,sender:e.sender,metadata:e.metadata};this.messages.push(t),window.dispatchEvent(new CustomEvent("sdk:message",{detail:{type:"MESSAGE_RECEIVED",message:t}}))},handleReceivedAudioStream(e){window.dispatchEvent(new CustomEvent("sdk:audioStream",{detail:{type:"AUDIO_STREAM_RECEIVED",audio:e}}))},convertRoleToEnum(e){if(!e)return;switch(e.toUpperCase()){case"USER":return o.MessageRole.USER;case"ASSISTANT":return o.MessageRole.ASSISTANT;case"SYSTEM":return o.MessageRole.SYSTEM;case"FUNCTION":return o.MessageRole.FUNCTION;case"DEFAULT":return o.MessageRole.DEFAULT;default:return}},handleReceivedChunk(e){try{const{channelMsgId:t,id:a,chunk:s}=e;if(!s)return;this.streaming=!0;const r=void 0!==s.choices?.[0]?.finish_reason&&null!==s.choices[0].finish_reason,n=s.choices?.[0]?.delta,i=n?.reasoning_content||"",c=this.convertRoleToEnum(n?.role)||o.MessageRole.ASSISTANT;let l=this.messages.find(e=>e.channelMsgId===t||e.id===a||e.uuid===a);if(l){if(i&&(l.reasoning_content=(l.reasoning_content||"")+i),l.messageState&&(l.messageState.isThinking=!!i,r&&l.messageState.isThinking&&(l.messageState.thinkEnd=Date.now())),l.body?.groups){const e=l.body.groups.get(t)||[];e.push(s),l.body.groups.set(t,e)}}else l={id:a||window.$uuid(),uuid:window.$uuid(),channelMsgId:t,reasoning_content:i||"",type:o.MessageType.TEXT,role:c,isOwn:!1,sendAt:window.$date.format(new Date),createdAt:window.$date.format(new Date),metadata:new Map([["streaming",!0],["isFinal",!1],["chunkCount",1]]),children:[],messageState:{isThinking:!!s.choices?.[0]?.delta?.reasoning_content,thinkStart:Date.now(),thinkEnd:void 0},actions:s.metadata?.actions||[],errorCode:void 0,receiveAt:void 0,modelId:s.model?parseInt(s.model):void 0,model:s.model,chatOptions:void 0,parentMessageId:s.metadata?.parent_message_id,temperature:void 0,receiverId:void 0,isError:!1,senderId:void 0,usedRag:!1,processingTime:void 0,userId:void 0,readAt:void 0,tokenCount:s.usage?.total_tokens,errorMessage:void 0,body:{id:s.id,groups:new Map([[t,[s]]]),completion:void 0,payload:void 0,thinkStart:void 0,thinkEnd:void 0}},this.messages.push(l);return l.body?.groups?.get(t)&&1!==l.body.groups.get(t)?.length?window.dispatchEvent(new CustomEvent("sdk:message",{detail:{type:"MESSAGE_STREAM_UPDATE",message:l,chunk:s}})):window.dispatchEvent(new CustomEvent("sdk:message",{detail:{type:"MESSAGE_RECEIVED",message:l}})),l}catch(t){throw console.error("处理流式消息块失败:",t),this.streaming=!1,t}},setMessageSendStatus(e,t){e.metadata=e.metadata||new Map,e.metadata.set("sendStatus",t),e.metadata.set("sendTimestamp",Date.now()),t===u.FAILED&&e.metadata.set("sendError","消息发送失败")},updateMessageSendStatus(e,t,a){const s=this.messages.find(t=>t.id===e||t.uuid===e);s&&(this.setMessageSendStatus(s,t),a&&s.metadata?.set("sendError",a))},async markMessageAsRead(e){const t=this.messages.find(t=>t.id===e||t.uuid===e);t&&(t.readAt=window.$date.format(new Date))},async deleteMessage(e){try{this.loading=!0,this.messages=this.messages.filter(t=>t.id!==e&&t.uuid!==e)}catch(t){throw this.error=t,t}finally{this.loading=!1}},async clearMessages(e){try{this.loading=!0,this.messages=e?this.messages.filter(t=>t.conversationId!==e):[]}catch(t){throw this.error=t,t}finally{this.loading=!1}},async searchMessages(e,t){try{this.loading=!0;let a=this.messages;t&&(a=a.filter(e=>e.conversationId===t));return a.filter(t=>{const a=r.getText(t);return!!a&&a.includes(e.toLowerCase())})}catch(a){throw this.error=a,a}finally{this.loading=!1}},getLastMessageByConversation(e){const t=this.messages.filter(t=>t.conversationId===e);return t[t.length-1]||null},getMessageCountByConversation(e){return this.messages.filter(t=>t.conversationId===e).length},reset(){this.messages=[],this.streaming=!1,this.currentStream=null,this.toolCalls=[],this.toolResults=[]}}});var p=(e=>(e.IOT="iot",e.SSE="sse",e.IM="im",e))(p||{});class E{async createHandler(e,t){switch(e){case p.IOT:return await this.createIotHandler(t);case p.SSE:return this.createSseHandler(t);case p.IM:return this.createImHandler(t);default:throw new Error(`不支持的消息处理器类型: ${e}`)}}async createIotHandler(e){const{IotMessageHandler:t}=await i(async()=>{const{IotMessageHandler:e}=await import("./iot-handler-pZ7oexFx.js");return{IotMessageHandler:e}},__vite__mapDeps([0,1,2,3,4,5,6]));return new t(e.config,e.eventEmitter,e.eventAdapter)}async createSseHandler(e){const{SseMessageHandler:t}=await i(async()=>{const{SseMessageHandler:e}=await import("./sse-handler-4-8cobXb.js");return{SseMessageHandler:e}},__vite__mapDeps([7,1,2,3,4,5,6]));return new t(e.config,e.eventEmitter,e.eventAdapter)}async createImHandler(e){const{ImMessageHandler:t}=await i(async()=>{const{ImMessageHandler:e}=await import("./im-handler-D-yfV81H.js");return{ImMessageHandler:e}},__vite__mapDeps([8,1,2,3,4]));return new t(e.config)}}class C{static toCompletionParam(e){let t=window.$chat.getTextFromPayload(e.body?.payload);return{messages:[{role:o.ChatCompletionRole.user,content:t}],stream:!0}}static toCompletionChunk(e,t){return{id:t.id,object:"chat.completion.chunk",created:t.created,model:t.model,choices:[{index:0,delta:{role:"assistant",content:e}}]}}static createMessage(e,t){const{messageType:a}=t;switch(a){case o.MessageType.TEXT:return this.createTextMessage(e,t);case o.MessageType.AUDIO:if(e.url)return this.createAudioMessageByUrl(e,t);if(e.file)return this.createAudioMessage(e,t);break;case o.MessageType.IMAGE:if(e.url)return this.createImageMessageByUrl(e,t);if(e.file)return this.createImageMessage(e,t);break;case o.MessageType.VIDEO:if(e.url)return this.createVideoMessageByUrl(e,t);if(e.file)return this.createVideoMessage(e,t);break;case o.MessageType.FILE:if(e.url)return this.createFileMessageByUrl(e,t);if(e.file)return this.createFileMessage(e,t);break;case o.MessageType.LOCATION:if(void 0!==e.latitude&&void 0!==e.longitude)return this.createLocationMessage(e,t);break;case o.MessageType.MUSIC:if(e.title&&e.artist&&e.url)return this.createMusicMessage(e,t)}throw new Error(`不支持的消息类型: ${a} 或缺少必要的参数`)}static createTextMessage(e,t){const a={text:{content:e.content}},s=this.createBaseMessageBody(a);return{...this.createCommonPart(t,o.MessageType.TEXT,s)}}static createAudioMessageByUrl(e,t){const a={audio:{content:e.content,resource:{url:e.url,duration:e.duration}}},s=this.createBaseMessageBody(a);return{...this.createCommonPart(t,o.MessageType.AUDIO,s)}}static createAudioMessage(e,t){const a=this.fileToDataURL(e.file,e.format||"wav"),s={audio:{content:e.content,resource:{url:a,duration:e.duration,localFile:e.file,format:e.format}}},r=this.createBaseMessageBody(s);return{...this.createCommonPart(t,o.MessageType.AUDIO,r)}}static createImageMessageByUrl(e,t){const a={image:{content:e.content,resource:{url:e.url,width:e.width,height:e.height,name:e.name,extension:e.extension}}},s=this.createBaseMessageBody(a);return{...this.createCommonPart(t,o.MessageType.IMAGE,s)}}static createImageMessage(e,t){const a=this.fileToDataURL(e.file,"image"),s={image:{content:e.content,resource:{url:a,width:e.width,height:e.height,name:e.name,extension:e.extension,localFile:e.file}}},r=this.createBaseMessageBody(s);return{...this.createCommonPart(t,o.MessageType.IMAGE,r)}}static createVideoMessageByUrl(e,t){const a={video:{content:e.content,resource:{url:e.url,duration:e.duration,size:e.size,name:e.name,extension:e.extension}}},s=this.createBaseMessageBody(a);return{...this.createCommonPart(t,o.MessageType.VIDEO,s)}}static createVideoMessage(e,t){const a=this.fileToDataURL(e.file,"video"),s={video:{content:e.content,resource:{url:a,duration:e.duration,localFile:e.file}}},r=this.createBaseMessageBody(s);return{...this.createCommonPart(t,o.MessageType.VIDEO,r)}}static createFileMessageByUrl(e,t){const a={file:{content:e.content,resource:{url:e.url,size:e.size,name:e.name,extension:e.extension}}},s=this.createBaseMessageBody(a);return{...this.createCommonPart(t,o.MessageType.FILE,s)}}static createFileMessage(e,t){const a=this.fileToDataURL(e.file,e.mimeType||"application/octet-stream"),s=e.file instanceof Blob||e.file instanceof File?e.file.size:e.file.byteLength,r={file:{content:e.content,resource:{url:a,size:s,name:e.name,extension:e.extension,localFile:e.file}}},n=this.createBaseMessageBody(r);return{...this.createCommonPart(t,o.MessageType.FILE,n)}}static createLocationMessage(e,t){const a={latitude:e.latitude,longitude:e.longitude},s={location:{content:e.address||"",location:a}},r=this.createBaseMessageBody(s);return{...this.createCommonPart(t,o.MessageType.LOCATION,r)}}static createMusicMessage(e,t){const a={text:{content:`${e.title} - ${e.artist}`}},s=this.createBaseMessageBody(a),r=new Map;t.metadata&&t.metadata.forEach((e,t)=>r.set(t,e)),r.set("music",{title:e.title,artist:e.artist,album:e.album,duration:e.duration,url:e.url,cover:e.cover});return{...this.createCommonPart({...t,metadata:r},o.MessageType.TEXT,s)}}static createChatCompletionMessage(e,t){const a={text:{content:e.content}},s=this.createBaseMessageBody(a);return{...this.createCommonPart(t,o.MessageType.TEXT,s)}}static createChatCompletionChunk(e,t){const a={text:{content:e.content}},s=this.createBaseMessageBody(a);return{...this.createCommonPart(t,o.MessageType.TEXT,s)}}static fromRawData(e,t){let a;a=e.content&&e.content.payload||e.content&&e.content.completion?e.content:e.content||{thinkStart:Date.now(),thinkEnd:Date.now()};const s=this.createCommonPart(t,t.messageType,a);return{...e,...s,uuid:e.uuid||s.uuid,createdAt:e.createdAt||s.createdAt,updatedAt:e.updatedAt||s.updatedAt}}static validateMessage(e){if(!e.type||!e.body)return!1;const t=e.body;return t.payload?this.validateIMMessage(e):!t.completion||this.validateChatMessage(e)}static validateIMMessage(e){const t=e.body;if(!t.payload)return!1;const a=t.payload;return!!(a.text||a.audio||a.image||a.video||a.file||a.location||a.music)}static validateChatMessage(e){return!!e.body.completion}static createBaseMessageBody(e){return{payload:e,thinkStart:Date.now(),thinkEnd:Date.now()}}static createCommonPart(e,t,a){const s=window.$date.format(new Date),r=this.mapChatContextFields(e.context);return{uuid:window.$uuid(),type:t,body:a,conversationId:e.conversationId,sendAt:s,metadata:e.metadata,createdAt:s,updatedAt:s,...r}}static mapChatContextFields(e){if(!e)return{};const t={};return Object.entries({conversation_id:"conversationId",user_id:e=>({userId:e.toString()}),knowledge_base_id:"knowledgeBaseId",agent_id:"agentId",flow_id:"flowId",datasource_id:"datasourceId",indent:"indent",parent_message_id:"parentMessageId",save_audio:"saveAudio"}).forEach(([a,s])=>{const r=e[a];null!=r&&("function"==typeof s?Object.assign(t,s(r)):t[s]=r)}),t}static fileToDataURL(e,t){if(e instanceof ArrayBuffer){return`data:${t};base64,${btoa(String.fromCharCode(...new Uint8Array(e)))}`}return Blob,URL.createObjectURL(e)}}const w=e("chat",{state:()=>({loading:!1,error:null,initialized:!1,options:{model:void 0,temperature:.7,max_tokens:2e3,top_p:1,frequency_penalty:0,presence_penalty:0,stream:!0,modalities:["text","audio"]},currentHandlerType:p.IOT,messageHandler:null,audioParams:{sample_rate:16e3,channels:1,format:"opus",frame_duration:60},_streamPlayer:null,speakState:"IDLE",currentChatMode:null,_audioStreamLogCounter:0}),getters:{isLoading:e=>e.loading,getError:e=>e.error,isInitialized:e=>e.initialized,currentOptions:e=>e.options,currentMessageHandler:e=>e.messageHandler,isSpeaking:e=>"SPEAKING"===e.speakState,isListening:e=>"LISTENING"===e.speakState,isIdle:e=>"IDLE"===e.speakState},actions:{async initialize(){try{this.loading=!0,await this.initializeMessageHandler(),this.initialized=!0}catch(e){this.error=e,console.error("初始化聊天Store失败:",e)}finally{this.loading=!1}},async initializeMessageHandler(){try{const e={config:await this.getIotConfig(),eventEmitter:this.createEventEmitter(),eventAdapter:this.createEventAdapter()},t=new E;this.messageHandler=await t.createHandler(this.currentHandlerType||p.IOT,e),await(this.messageHandler?.initialize())}catch(e){this.error=e,console.error("初始化消息处理器失败:",e)}},async enterChat(e={}){try{this.loading=!0;const{mode:a="text",forceReconnect:s=!1}=e;if(this.messageHandler?(console.log("消息处理器已存在，连接保持活跃"),this.messageHandler.isConnected()||console.warn("消息处理器连接异常，但整体应用连接应保持活跃")):(console.log("初始化消息处理器..."),await this.initializeMessageHandler()),this.messageHandler){const e=h().getOrCreateChatContext();e&&(this.messageHandler.enter({chatContext:e}),console.log("调用MessageHandler enter方法，进入聊天会话"))}console.log("创建音频播放器...");try{await this.createStreamPlayer(),console.log("音频播放器创建成功")}catch(t){throw console.error("音频播放器创建失败:",t),t}switch(a){case"voice":await this.initVoiceRoom();break;case"rtc":await this.initRtcRoom()}console.log("加载当前会话消息..."),await this.loadCurrentConversationMessages(),this.currentChatMode=a}catch(t){this.error=t,console.error("进入聊天会话失败:",t)}finally{this.loading=!1}},async exitChat(){try{this.loading=!0;const e=this.currentChatMode;switch(e){case"voice":await this.exitVoiceRoom();break;case"rtc":await this.exitRtcRoom()}if(this.messageHandler){const e=h().getOrCreateChatContext();e&&(this.messageHandler.exit({chatContext:e}),console.log("调用MessageHandler exit方法，退出聊天会话"))}this._streamPlayer&&await this.destroyStreamPlayer(),this.stopVoiceListening(),this.stopListeningToRecorderStream(),this.speakState="IDLE",this.currentChatMode=null,console.log(`成功退出${e}聊天会话，消息处理器连接保持活跃`)}catch(e){this.error=e,console.error("退出聊天会话失败:",e)}finally{this.loading=!1}},async switchChatMode(e){try{this.loading=!0;const t=this.currentChatMode;if(t)switch(t){case"voice":await this.exitVoiceRoom();break;case"rtc":await this.exitRtcRoom()}switch(e){case"voice":await this.initVoiceRoom();break;case"rtc":await this.initRtcRoom()}this.currentChatMode=e,console.log(`成功从${t}切换到${e}模式`)}catch(t){this.error=t,console.error("切换聊天模式失败:",t)}finally{this.loading=!1}},async initVoiceRoom(){try{console.log("初始化语音房间..."),console.log("开始监听recorder流数据..."),this.listenToRecorderStream(),console.log("语音房间初始化完成")}catch(e){throw console.error("初始化语音房间失败:",e),e}},async initRtcRoom(){try{console.log("初始化RTC房间..."),console.log("RTC房间初始化完成 - 暂不处理RTC相关操作")}catch(e){console.error("初始化RTC房间失败:",e)}},async enterVoiceRoom(e={}){let t=!1;try{if(console.log("进入语音房间，开始recorder初始化..."),(this._streamPlayer?.isPlayEnd()||this._streamPlayer?.isStop())&&await this.createStreamPlayer(),console.log("检查音频播放器状态..."),!this._streamPlayer)throw console.error("音频播放器不存在，语音房间无法正常工作"),new Error("音频播放器未初始化");if(console.log("播放器存在，检查状态:",{isPlayable:this._streamPlayer.isPlayable(),isStop:this._streamPlayer.isStop(),isPause:this._streamPlayer.isPause(),isPlayEnd:this._streamPlayer.isPlayEnd()}),this._streamPlayer.isPlayEnd()&&(console.log("播放器处于播放结束状态，重新启动播放器..."),await this._streamPlayer.start(this.audioParams?.sample_rate,this.audioParams?.channels),console.log("播放器重启完成")),e.hello?.send)try{console.log("尝试发送hello消息..."),console.log("hello消息发送完成")}catch(a){console.error("发送hello消息失败:",a)}const{enableWave:r=!0,waveContainer:o=null,sampleRate:n=16e3,format:i="pcm",realtime:c=!0}=e,l=d();o&&r&&l.setWaveContainer(o);try{await l.startRecording({realtime:c,enableWave:r,waveContainer:o,sampleRate:n,format:i}),console.log("语音房间recorder初始化完成"),t=!0}catch(s){console.error("recorder录制失败，但继续执行后续操作:",s),this.error=s}}catch(s){console.error("进入语音房间失败，recorder初始化异常:",s),this.error=s}return{recorderInitialized:t}},async exitVoiceRoom(){try{if(this.messageHandler){const e=h();e.getOrCreateChatContext()&&this.messageHandler.abort({reason:"exit_room"})}const e=d();await e.stopRecording(),e.destroyRecorder(),console.log("语音房间recorder销毁完成"),this._streamPlayer&&(console.log("重置音频播放器状态..."),await this._streamPlayer.pause(),this._streamPlayer.clearInput(),console.log("音频播放器状态重置完成"))}catch(e){console.error("退出语音房间失败:",e)}},async enterRtcRoom(){console.log("进入RTC房间 - 暂不处理RTC相关操作")},async exitRtcRoom(){console.log("退出RTC房间 - 暂不处理RTC相关操作")},async loadCurrentConversationMessages(){try{const e=h(),t=y(),a=e.currentConversation;if(!a)return void console.warn("没有当前会话，跳过加载消息");await t.loadMessages({conversationId:a.id||a.uuid,page:1,size:20}),console.log("成功加载当前会话消息")}catch(e){console.error("加载当前会话消息失败:",e)}},async createStreamPlayer(){try{return this._streamPlayer&&(console.log("播放器已存在，先销毁旧播放器"),await this.destroyStreamPlayer()),console.log("创建新的音频播放器实例"),this._streamPlayer=new g({realtime:!0}),await this._streamPlayer.start(this.audioParams?.sample_rate,this.audioParams?.channels),console.log("流式音频播放器创建成功，当前状态:",{isPlayable:this._streamPlayer.isPlayable(),isStop:this._streamPlayer.isStop(),isPause:this._streamPlayer.isPause(),isPlayEnd:this._streamPlayer.isPlayEnd()}),this._streamPlayer}catch(e){throw console.error("创建流式音频播放器失败:",e),this._streamPlayer=null,e}},async destroyStreamPlayer(){try{this._streamPlayer&&(await this._streamPlayer.pause(),this._streamPlayer.clearInput(),this._streamPlayer.stop(),await new Promise(e=>setTimeout(e,100)),this._streamPlayer=null,console.log("流式音频播放器销毁成功"))}catch(e){console.error("销毁流式音频播放器失败:",e),this._streamPlayer=null}},async switchHandlerType(e){try{this.loading=!0,this.messageHandler&&(await this.messageHandler.destroy(),this.messageHandler=null),this.currentHandlerType=e,await this.initializeMessageHandler()}catch(t){this.error=t}finally{this.loading=!1}},getDeviceInfo(){let e=localStorage.getItem("sdkwork-device-id");return e||(e=(()=>{const e=[navigator.userAgent,navigator.language,navigator.hardwareConcurrency||"",screen.width,screen.height,screen.colorDepth,(new Date).getTimezoneOffset()].join("|");let t=0;for(let a=0;a<e.length;a++)t=(t<<5)-t+e.charCodeAt(a),t&=t;return`web-device-${Math.abs(t).toString(36)}`})(),localStorage.setItem("sdkwork-device-id",e)),{deviceId:e,deviceType:"web",userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,screenResolution:`${screen.width}x${screen.height}`,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone}},async getIotConfig(){const e=this.getDeviceInfo(),t=n().token||"your-auth-token",a=`${e.deviceId}-${Date.now()}-${Math.random().toString(36).substring(2,9)}`;return{deviceId:e.deviceId,clientId:a,authorization:t,baseUrl:l.websocketBaseURL,transport:"websocket",protocol:"sdkwork",timeout:3e4,maxRetries:5,debug:!0,logLevel:"info",apiKey:void 0,authType:void 0,audioParams:{format:"opus",sample_rate:16e3,channels:1,frame_duration:60},features:void 0}},createEventEmitter(){return{emit:e=>{this.handleEvent(e)}}},createEventAdapter:()=>({adaptConnectionChange:e=>({type:"CONNECTION_CHANGE",state:e}),adaptMessageReceived:e=>({type:"MESSAGE_RECEIVED",message:e}),adaptMessageChunkReceived:e=>({type:"MESSAGE_CHUNK_RECEIVED",message:e}),adaptAudioStreamReceived:e=>({type:"AUDIO_STREAM_RECEIVED",audio:e}),adaptDataReceived:e=>({type:"DATA_RECEIVED",data:e}),adaptToolCallReceived:e=>({type:"TOOL_CALL_RECEIVED",tool:e}),adaptErrorOccurred:e=>({type:"ERROR_OCCURRED",error:e}),adaptIotEventReceived:(e,t)=>({type:"IOT_EVENT_RECEIVED",eventType:e,event:t})}),handleEvent(e){const t=y();switch(e.type){case"CONNECTION_CHANGE":case"DATA_RECEIVED":case"TOOL_CALL_RECEIVED":break;case"MESSAGE_RECEIVED":t.handleReceivedMessage(e.message);break;case"MESSAGE_CHUNK_RECEIVED":t.handleReceivedChunk(e.message);break;case"AUDIO_STREAM_RECEIVED":this._audioStreamLogCounter++,this._audioStreamLogCounter%100==1&&console.log(`[AUDIO_STREAM_RECEIVED] 接收到第${this._audioStreamLogCounter}次音频流数据`,{hasData:!!e.audio?.data,hasChannelData:!!e.audio?.data?.channelData,channelCount:e.audio?.data?.channelData?.length||0});const a=e.audio.data;if(a.channelData){const e=a.channelData[0];if(!e||!e.length)return void console.warn("channelData无效，跳过播放");this._streamPlayer&&this._streamPlayer.isPlayable()?this._streamPlayer.appendStreamData(e):console.warn("音频播放器不可用，丢弃音频数据。播放器状态:",{playerExists:!!this._streamPlayer,isPlayable:!!this._streamPlayer&&this._streamPlayer.isPlayable(),isStop:this._streamPlayer?this._streamPlayer.isStop():"N/A",isPause:this._streamPlayer?this._streamPlayer.isPause():"N/A",isPlayEnd:this._streamPlayer?this._streamPlayer.isPlayEnd():"N/A"})}t.handleReceivedAudioStream(e.audio);break;case"ERROR_OCCURRED":this.error=e.error;break;case"IOT_EVENT_RECEIVED":console.error("event====event=======IOT_EVENT_RECEIVED===",e);break;default:console.error("event====unknow==========",e)}},async sendHello(e,t){const a=h().getOrCreateChatContext(t);a&&(a.chat_options=this.options);const s=a?this.filterContext(a):this.createDefaultChatContext();this.messageHandler?.sendHello(e,{chatContext:s,audioParams:this.audioParams})},async sendText(e,t){const a=h().getOrCreateChatContext(t);a&&(a.chat_options=this.options);const s=a?this.filterContext(a):this.createDefaultChatContext(),r=C.createTextMessage({content:e},{messageType:o.MessageType.TEXT,context:s});return this.sendMessage(r,s)},async sendMessage(e,t){try{this.loading=!0,await this.ensurePlayerReady();const a=c().currentUser;e.sender={id:a?.id,name:a?.nickname,face:a?.faceImage};const s=h().getOrCreateChatContext(t);s&&(s.chat_options=this.options);const r=s?this.filterContext(s):this.createDefaultChatContext(),o=y();return await o.saveMessage(e,r),this.messageHandler?(this.messageHandler.send(e,t||this.createDefaultChatContext()),e.uuid):void console.error("消息处理器未连接")}catch(a){this.error=a,console.error("sendMessage error",a)}finally{this.loading=!1}},async sendAudioStream(e,t){try{if(this.loading=!0,!this.messageHandler||!this.messageHandler.isConnected())return void console.error("消息处理器未连接");const a=h().getOrCreateChatContext(t);a&&(a.chat_options=this.options);a?this.filterContext(a):this.createDefaultChatContext();let s;s=e instanceof Blob?await e.arrayBuffer():e,this.messageHandler.sendAudioStream&&this.messageHandler.sendAudioStream(e,1,t||this.createDefaultChatContext())}catch(a){this.error=a,console.error("sendAudioStream error",a)}finally{this.loading=!1}},filterContext(e,t){const a={...e};return t&&Object.assign(a,t),a},async ensurePlayerReady(){if(!this._streamPlayer)throw console.error("音频播放器不存在，请先调用enterChat方法初始化聊天会话"),new Error("音频播放器未初始化");console.log("当前播放器状态:",{isStop:this._streamPlayer.isStop(),isPause:this._streamPlayer.isPause(),isPlayEnd:this._streamPlayer.isPlayEnd()}),this._streamPlayer.isStop()&&!this._streamPlayer.isPlayEnd()&&(console.log("播放器处于停止状态，启动播放器"),await this._streamPlayer.start(this.audioParams?.sample_rate,this.audioParams?.channels))},async startPlayer(){try{if(!this._streamPlayer)return void console.error("音频播放器不存在，请先调用enterChat方法初始化聊天会话");await this._streamPlayer.start(this.audioParams?.sample_rate,this.audioParams?.channels),console.log("音频播放器重启成功")}catch(e){console.error("重启音频播放器失败:",e)}},startVoiceListening(){this.messageHandler&&this.messageHandler.isConnected()&&this.messageHandler.startListening()},stopVoiceListening(){this.messageHandler&&this.messageHandler.isConnected()&&this.messageHandler.stopListening()},reset(){this.messageHandler=null,this.speakState="IDLE"},async cleanup(){try{console.log("开始清理chatStore资源..."),this.stopVoiceListening(),this.stopListeningToRecorderStream(),this._streamPlayer&&await this.destroyStreamPlayer(),this.reset(),this.error=null,this.initialized=!1,console.log("chatStore资源清理完成，消息处理器连接保持活跃")}catch(e){console.error("chatStore资源清理失败:",e)}},setSpeakState(e){this.speakState=e},setSpeaking(){this.speakState="SPEAKING"},setListening(){this.speakState="LISTENING"},setIdle(){this.speakState="IDLE"},listenToRecorderStream(){window.$on?(window.$on("recorder:stream-data",this.handleRecorderStreamData.bind(this)),console.log("已开始监听recorder流数据事件")):console.warn("window.$on 未定义，无法监听流数据事件")},handleRecorderStreamData(e){try{if(!this.messageHandler)return void console.error("消息处理器未初始化，请先调用enterChat方法初始化聊天会话");if(!this.messageHandler?.isConnected())return void console.warn("消息处理器未连接，当前无法处理音频数据");this.sendAudioStream(e)}catch(t){console.error("处理recorder流数据事件时发生错误:",t)}},stopListeningToRecorderStream(){window.$off?(window.$off("recorder:stream-data",this.handleRecorderStreamData),console.log("已停止监听recorder流数据事件")):console.warn("window.$off 未定义，无法取消监听流数据事件")},createDefaultChatContext(){const e=h().currentConversationId;return{conversation_id:e||void 0,conversation_uuid:e||void 0}}}});export{C as M,w as a,y as u};
