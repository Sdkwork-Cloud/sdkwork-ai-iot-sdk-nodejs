import{k as e,j as a,r as l,l as i,t,v as o,n as s,q as r,a as n}from"./vue-vendor-a2672387.js";import{k as d,ac as u,a9 as c,n as p,W as m,I as v,L as f,m as g,U as w,af as b,K as y,p as x,o as h,t as U,X as j,H as k,a4 as z,a8 as R,T as S,w as F}from"./index-5affcab4.js";import"./index-5d6825eb.js";import{I as V}from"./index-4fcf5799.js";import{s as L}from"./function-call-e02e5da4.js";const[A,C,I]=d("uploader");function O(e,a){return new Promise(l=>{if("file"===a)return void l();const i=new FileReader;i.onload=e=>{l(e.target.result)},"dataUrl"===a?i.readAsDataURL(e):"text"===a&&i.readAsText(e)})}function P(e,a){return u(e).some(e=>!!e.file&&(c(a)?a(e.file):e.file.size>+a))}const B=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg|avif)/i;function T(e){return!!e.isImage||(e.file&&e.file.type?0===e.file.type.indexOf("image"):e.url?(a=e.url,B.test(a)):"string"==typeof e.content&&0===e.content.indexOf("data:image"));var a}var D=e({props:{name:p,item:m(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,reupload:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview","reupload"],setup(e,{emit:l,slots:i}){const t=()=>{const{status:l,message:i}=e.item;if("uploading"===l||"failed"===l){const e="failed"===l?a(v,{name:"close",class:C("mask-icon")},null):a(f,{class:C("loading")},null),t=w(i)&&""!==i;return a("div",{class:C("mask")},[e,t&&a("div",{class:C("mask-message")},[i])])}},o=a=>{const{name:i,item:t,index:o,beforeDelete:s}=e;a.stopPropagation(),b(s,{args:[t,{name:i,index:o}],done:()=>l("delete")})},s=()=>l("preview"),r=()=>l("reupload"),n=()=>{if(e.deletable&&"uploading"!==e.item.status){const e=i["preview-delete"];return a("div",{role:"button",class:C("preview-delete",{shadow:!e}),tabindex:0,"aria-label":I("delete"),onClick:o},[e?e():a(v,{name:"cross",class:C("preview-delete-icon")},null)])}},d=()=>{if(i["preview-cover"]){const{index:l,item:t}=e;return a("div",{class:C("preview-cover")},[i["preview-cover"](y({index:l},t))])}},u=()=>{const{item:l,lazyLoad:i,imageFit:t,previewSize:o,reupload:n}=e;return T(l)?a(V,{fit:t,src:l.objectUrl||l.content||l.url,class:C("preview-image"),width:Array.isArray(o)?o[0]:o,height:Array.isArray(o)?o[1]:o,lazyLoad:i,onClick:n?r:s},{default:d}):a("div",{class:C("file"),style:g(e.previewSize)},[a(v,{class:C("file-icon"),name:"description"},null),a("div",{class:[C("file-name"),"van-ellipsis"]},[l.file?l.file.name:l.url]),d()])};return()=>a("div",{class:C("preview")},[u(),t(),n()])}});var N=e({name:A,props:{name:x(""),accept:h("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:x(1/0),imageFit:h("cover"),resultType:h("dataUrl"),uploadIcon:h("photograph"),uploadText:String,deletable:U,reupload:Boolean,afterRead:Function,showUpload:U,modelValue:j(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:U,previewOptions:Object,previewFullImage:U,maxSize:{type:[Number,String,Function],default:1/0}},emits:["delete","oversize","clickUpload","closePreview","clickPreview","clickReupload","update:modelValue"],setup(e,{emit:d,slots:c}){const p=l(),m=[],f=l(-1),w=l(!1),b=(a=e.modelValue.length)=>({name:e.name,index:a}),x=()=>{p.value&&(p.value.value="")},h=a=>{if(x(),P(a,e.maxSize)){if(!Array.isArray(a))return void d("oversize",a,b());{const l=function(e,a){const l=[],i=[];return e.forEach(e=>{P(e,a)?i.push(e):l.push(e)}),{valid:l,invalid:i}}(a,e.maxSize);if(a=l.valid,d("oversize",l.invalid,b()),!a.length)return}}if(a=n(a),f.value>-1){const l=[...e.modelValue];l.splice(f.value,1,a),d("update:modelValue",l),f.value=-1}else d("update:modelValue",[...e.modelValue,...u(a)]);e.afterRead&&e.afterRead(a,b())},U=a=>{const{maxCount:l,modelValue:i,resultType:t}=e;if(Array.isArray(a)){const e=+l-i.length;a.length>e&&(a=a.slice(0,e)),Promise.all(a.map(e=>O(e,t))).then(e=>{const l=a.map((a,l)=>{const i={file:a,status:"",message:"",objectUrl:URL.createObjectURL(a)};return e[l]&&(i.content=e[l]),i});h(l)})}else O(a,t).then(e=>{const l={file:a,status:"",message:"",objectUrl:URL.createObjectURL(a)};e&&(l.content=e),h(l)})},j=a=>{const{files:l}=a.target;if(e.disabled||!l||!l.length)return;const i=1===l.length?l[0]:[].slice.call(l);if(e.beforeRead){const a=e.beforeRead(i,b());if(!a)return void x();if(R(a))return void a.then(e=>{U(e||i)}).catch(x)}U(i)};let F;const V=()=>d("closePreview"),A=e=>{w.value=!0,f.value=e,s(()=>H())},I=()=>{w.value||(f.value=-1),w.value=!1},B=(l,i)=>{const t=["imageFit","deletable","reupload","previewSize","beforeDelete"],o=y(S(e,t),S(l,t,!0));return a(D,r({item:l,index:i,onClick:()=>d(e.reupload?"clickReupload":"clickPreview",l,b(i)),onDelete:()=>((a,l)=>{const i=e.modelValue.slice(0);i.splice(l,1),d("update:modelValue",i),d("delete",a,b(l))})(l,i),onPreview:()=>(a=>{if(e.previewFullImage){const l=e.modelValue.filter(T),i=l.map(e=>(e.objectUrl&&!e.url&&"failed"!==e.status&&(e.url=e.objectUrl,m.push(e.url)),e.url)).filter(Boolean);F=L(y({images:i,startPosition:l.indexOf(a),onClose:V},e.previewOptions))}})(l),onReupload:()=>A(i)},S(e,["name","lazyLoad"]),o),S(c,["preview-cover","preview-delete"]))},N=()=>{if(e.previewImage)return e.modelValue.map(B)},E=e=>d("clickUpload",e),q=()=>{const l=e.modelValue.length<+e.maxCount,i=e.readonly?null:a("input",{ref:p,type:"file",class:C("input"),accept:e.accept,capture:e.capture,multiple:e.multiple&&-1===f.value,disabled:e.disabled,onChange:j,onClick:I},null);return c.default?t(a("div",{class:C("input-wrapper"),onClick:E},[c.default(),i]),[[o,l]]):t(a("div",{class:C("upload",{readonly:e.readonly}),style:g(e.previewSize),onClick:E},[a(v,{name:e.uploadIcon,class:C("upload-icon")},null),e.uploadText&&a("span",{class:C("upload-text")},[e.uploadText]),i]),[[o,e.showUpload&&l]])},H=()=>{p.value&&!e.disabled&&p.value.click()};return i(()=>{m.forEach(e=>URL.revokeObjectURL(e))}),k({chooseFile:H,reuploadFile:A,closeImagePreview:()=>{F&&F.close()}}),z(()=>e.modelValue),()=>a("div",{class:C()},[a("div",{class:C("wrapper",{disabled:e.disabled})},[N(),q()])])}});const E=F(N);export{E as U};
