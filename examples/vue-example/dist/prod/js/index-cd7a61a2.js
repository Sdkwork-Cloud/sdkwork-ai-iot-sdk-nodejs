import{k as e,j as a,r as l,l as i,t,v as o,n as r,q as s,a as n}from"./vue-vendor-fce65f55.js";import{m as d,ag as u,ad as c,o as p,a4 as m,I as v,L as f,p as g,z as w,E as b,Z as x,r as y,q as h,t as z,a5 as U,X as j,x as k,ac as R,V as S,w as V}from"./index-2cafbb5e.js";import{s as F}from"./index-6ac85e31.js";import{I as L}from"./index-a5403cf2.js";const[A,C,I]=d("uploader");function O(e,a){return new Promise(l=>{if("file"===a)return void l();const i=new FileReader;i.onload=e=>{l(e.target.result)},"dataUrl"===a?i.readAsDataURL(e):"text"===a&&i.readAsText(e)})}function P(e,a){return u(e).some(e=>!!e.file&&(c(a)?a(e.file):e.file.size>+a))}const B=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg|avif)/i;function D(e){return!!e.isImage||(e.file&&e.file.type?0===e.file.type.indexOf("image"):e.url?(a=e.url,B.test(a)):"string"==typeof e.content&&0===e.content.indexOf("data:image"));var a}var T=e({props:{name:p,item:m(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,reupload:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview","reupload"],setup(e,{emit:l,slots:i}){const t=()=>{const{status:l,message:i}=e.item;if("uploading"===l||"failed"===l){const e="failed"===l?a(v,{name:"close",class:C("mask-icon")},null):a(f,{class:C("loading")},null),t=w(i)&&""!==i;return a("div",{class:C("mask")},[e,t&&a("div",{class:C("mask-message")},[i])])}},o=a=>{const{name:i,item:t,index:o,beforeDelete:r}=e;a.stopPropagation(),b(r,{args:[t,{name:i,index:o}],done:()=>l("delete")})},r=()=>l("preview"),s=()=>l("reupload"),n=()=>{if(e.deletable&&"uploading"!==e.item.status){const e=i["preview-delete"];return a("div",{role:"button",class:C("preview-delete",{shadow:!e}),tabindex:0,"aria-label":I("delete"),onClick:o},[e?e():a(v,{name:"cross",class:C("preview-delete-icon")},null)])}},d=()=>{if(i["preview-cover"]){const{index:l,item:t}=e;return a("div",{class:C("preview-cover")},[i["preview-cover"](x({index:l},t))])}},u=()=>{const{item:l,lazyLoad:i,imageFit:t,previewSize:o,reupload:n}=e;return D(l)?a(L,{fit:t,src:l.objectUrl||l.content||l.url,class:C("preview-image"),width:Array.isArray(o)?o[0]:o,height:Array.isArray(o)?o[1]:o,lazyLoad:i,onClick:n?s:r},{default:d}):a("div",{class:C("file"),style:g(e.previewSize)},[a(v,{class:C("file-icon"),name:"description"},null),a("div",{class:[C("file-name"),"van-ellipsis"]},[l.file?l.file.name:l.url]),d()])};return()=>a("div",{class:C("preview")},[u(),t(),n()])}});var N=e({name:A,props:{name:y(""),accept:h("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:y(1/0),imageFit:h("cover"),resultType:h("dataUrl"),uploadIcon:h("photograph"),uploadText:String,deletable:z,reupload:Boolean,afterRead:Function,showUpload:z,modelValue:U(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:z,previewOptions:Object,previewFullImage:z,maxSize:{type:[Number,String,Function],default:1/0}},emits:["delete","oversize","clickUpload","closePreview","clickPreview","clickReupload","update:modelValue"],setup(e,{emit:d,slots:c}){const p=l(),m=[],f=l(-1),w=l(!1),b=(a=e.modelValue.length)=>({name:e.name,index:a}),y=()=>{p.value&&(p.value.value="")},h=a=>{if(y(),P(a,e.maxSize)){if(!Array.isArray(a))return void d("oversize",a,b());{const l=function(e,a){const l=[],i=[];return e.forEach(e=>{P(e,a)?i.push(e):l.push(e)}),{valid:l,invalid:i}}(a,e.maxSize);if(a=l.valid,d("oversize",l.invalid,b()),!a.length)return}}if(a=n(a),f.value>-1){const l=[...e.modelValue];l.splice(f.value,1,a),d("update:modelValue",l),f.value=-1}else d("update:modelValue",[...e.modelValue,...u(a)]);e.afterRead&&e.afterRead(a,b())},z=a=>{const{maxCount:l,modelValue:i,resultType:t}=e;if(Array.isArray(a)){const e=+l-i.length;a.length>e&&(a=a.slice(0,e)),Promise.all(a.map(e=>O(e,t))).then(e=>{const l=a.map((a,l)=>{const i={file:a,status:"",message:"",objectUrl:URL.createObjectURL(a)};return e[l]&&(i.content=e[l]),i});h(l)})}else O(a,t).then(e=>{const l={file:a,status:"",message:"",objectUrl:URL.createObjectURL(a)};e&&(l.content=e),h(l)})},U=a=>{const{files:l}=a.target;if(e.disabled||!l||!l.length)return;const i=1===l.length?l[0]:[].slice.call(l);if(e.beforeRead){const a=e.beforeRead(i,b());if(!a)return void y();if(R(a))return void a.then(e=>{z(e||i)}).catch(y)}z(i)};let V;const L=()=>d("closePreview"),A=e=>{w.value=!0,f.value=e,r(()=>X())},I=()=>{w.value||(f.value=-1),w.value=!1},B=(l,i)=>{const t=["imageFit","deletable","reupload","previewSize","beforeDelete"],o=x(S(e,t),S(l,t,!0));return a(T,s({item:l,index:i,onClick:()=>d(e.reupload?"clickReupload":"clickPreview",l,b(i)),onDelete:()=>((a,l)=>{const i=e.modelValue.slice(0);i.splice(l,1),d("update:modelValue",i),d("delete",a,b(l))})(l,i),onPreview:()=>(a=>{if(e.previewFullImage){const l=e.modelValue.filter(D),i=l.map(e=>(e.objectUrl&&!e.url&&"failed"!==e.status&&(e.url=e.objectUrl,m.push(e.url)),e.url)).filter(Boolean);V=F(x({images:i,startPosition:l.indexOf(a),onClose:L},e.previewOptions))}})(l),onReupload:()=>A(i)},S(e,["name","lazyLoad"]),o),S(c,["preview-cover","preview-delete"]))},N=()=>{if(e.previewImage)return e.modelValue.map(B)},E=e=>d("clickUpload",e),q=()=>{const l=e.modelValue.length<+e.maxCount,i=e.readonly?null:a("input",{ref:p,type:"file",class:C("input"),accept:e.accept,capture:e.capture,multiple:e.multiple&&-1===f.value,disabled:e.disabled,onChange:U,onClick:I},null);return c.default?t(a("div",{class:C("input-wrapper"),onClick:E},[c.default(),i]),[[o,l]]):t(a("div",{class:C("upload",{readonly:e.readonly}),style:g(e.previewSize),onClick:E},[a(v,{name:e.uploadIcon,class:C("upload-icon")},null),e.uploadText&&a("span",{class:C("upload-text")},[e.uploadText]),i]),[[o,e.showUpload&&l]])},X=()=>{p.value&&!e.disabled&&p.value.click()};return i(()=>{m.forEach(e=>URL.revokeObjectURL(e))}),j({chooseFile:X,reuploadFile:A,closeImagePreview:()=>{V&&V.close()}}),k(()=>e.modelValue),()=>a("div",{class:C()},[a("div",{class:C("wrapper",{disabled:e.disabled})},[N(),q()])])}});const E=V(N);export{E as U};
