import{a as e,_ as a}from"./index-5affcab4.js";import{k as l,r as s,c as t,w as o,Q as i,R as u,S as d,j as n,u as r,$ as c,X as p,U as f,F as v,Y as m,V as g,n as b}from"./vue-vendor-a2672387.js";const h={class:"sdkwork-uploader-file"},y={class:"upload-content"},k={class:"upload-icon"},w={class:"upload-text"},x={class:"upload-title"},$={class:"upload-subtitle"},C={key:0,class:"file-list"},F={class:"file-list-header"},z={class:"file-items"},I={class:"file-info"},B={class:"file-icon"},U={class:"file-details"},V={class:"file-name"},D={class:"file-size"},M={class:"file-actions"},S={key:0,class:"upload-progress"},T={class:"progress-bar"},_={class:"progress-text"},j={key:1,class:"status-icons"},E={key:0,class:"success-icon"},A={key:1,class:"error-icon"},G={class:"action-buttons"},K=["onClick"],L=["onClick"],Q={key:1,class:"upload-actions"},R=["disabled"],X=a(l({__name:"sdkwork-uploader-file",props:{modelValue:{default:()=>[]},accept:{default:"*/*"},multiple:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},autoUpload:{type:Boolean,default:!0},maxSize:{default:104857600},maxCount:{default:10},title:{default:"点击或拖拽文件到此处"},subtitle:{default:"支持所有文件类型"},bucket:{default:void 0},scene:{default:"default"},metadata:{default:()=>({})},contentType:{default:"application/octet-stream"},acl:{default:"private"}},emits:["update:modelValue","upload-start","upload-progress","upload-success","upload-error","upload-complete","file-add","file-remove","file-clear"],setup(a,{expose:l,emit:X}){const Y=a,q=X;s();const H=s(!1),J=s([]),N=t(()=>J.value.filter(e=>"uploading"===e.status).length),O=t(()=>0===Y.maxCount||J.value.length<Y.maxCount);o(()=>Y.modelValue,e=>{if(e&&e.length>0){const a=J.value.map(e=>e.id),l=e.filter(e=>!a.includes(P(e))).map(e=>W(e));J.value=[...J.value,...l],Y.autoUpload&&b(()=>{ie()})}},{immediate:!0});const P=e=>`${e.name}-${e.size}-${e.lastModified}`,W=e=>({id:P(e),file:e,name:e.name,size:e.size,status:"pending",progress:0}),Z=e=>{if(0===e)return"0 B";const a=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,a)).toFixed(2))+" "+["B","KB","MB","GB"][a]},ee=async()=>{if(!Y.disabled&&O.value)try{const e=await window.$files.chooseFile({count:Y.multiple?Y.maxCount:1,success:e=>{console.log("文件选择成功:",e)},fail:e=>{console.error("文件选择失败:",e)},complete:()=>{console.log("文件选择完成")}});e.tempFiles&&e.tempFiles.length>0&&te(e.tempFiles)}catch(e){console.error("文件选择异常:",e)}},ae=e=>{e.preventDefault(),!Y.disabled&&O.value&&(H.value=!0)},le=e=>{e.preventDefault(),H.value=!1},se=e=>{e.preventDefault(),H.value=!1,!Y.disabled&&O.value&&e.dataTransfer?.files&&te(Array.from(e.dataTransfer.files))},te=e=>{if(0===e.length)return;const a=0===Y.maxCount?1/0:Y.maxCount-J.value.length,l=e.slice(0,a);if(0===l.length)return void window.$message?.warning(`最多只能上传 ${Y.maxCount} 个文件`);const s=[],t=[];if(l.forEach(e=>{e.size>Y.maxSize?t.push(e):s.push(e)}),t.length>0&&window.$message?.error(`以下文件超过最大限制 ${Z(Y.maxSize)}: ${t.map(e=>e.name).join(", ")}`),0===s.length)return;const o=s.map(e=>W(e));J.value=[...J.value,...o];const i=J.value.map(e=>e.file);q("update:modelValue",i),q("file-add",s),Y.autoUpload&&ie()},oe=()=>{J.value.forEach(e=>{"uploading"===e.status&&e.uploadId&&window.$uploader?.cancel(e.uploadId)}),J.value=[],q("update:modelValue",[]),q("file-clear")},ie=async()=>{const e=J.value.filter(e=>"pending"===e.status);if(0!==e.length){for(const a of e)await ue(a);q("upload-complete",J.value.map(e=>e.file))}},ue=async e=>{if(window.$uploader){e.status="uploading",e.progress=0,q("upload-start",e.file);try{const a={file:e.file,bucket:Y.bucket||{name:"default-bucket"},name:e.name,scene:Y.scene,metadata:Y.metadata,contentType:Y.contentType,acl:Y.acl},l=await window.$uploader.upload(a,a=>{e.progress=a.percentage,q("upload-progress",e.file,a.percentage)});e.status="success",e.progress=100,q("upload-success",e.file,l)}catch(a){e.status="error",q("upload-error",e.file,a),console.error("Upload failed:",a)}}else console.error("Uploader not available")};return l({clearFiles:()=>{oe()},uploadFiles:()=>{ie()},getFileList:()=>J.value.map(e=>({file:e.file,status:e.status,progress:e.progress,response:"success"===e.status?"uploaded":void 0}))}),(l,s)=>(i(),u("div",h,[d("div",{class:p(["upload-area",{"drag-over":H.value,disabled:a.disabled}]),onClick:ee,onDrop:se,onDragover:ae,onDragleave:le},[d("div",y,[d("div",k,[n(r(e),{icon:"material-symbols:cloud-upload",width:"48",height:"48"})]),d("div",w,[d("p",x,c(a.title),1),d("p",$,c(a.subtitle),1)])])],34),J.value.length>0?(i(),u("div",C,[d("div",F,[d("span",null,"已选择文件 ("+c(J.value.length)+")",1),J.value.length>1?(i(),u("button",{key:0,type:"button",class:"clear-all-btn",onClick:oe}," 清空全部 ")):f("",!0)]),d("div",z,[(i(!0),u(v,null,m(J.value,a=>(i(),u("div",{key:a.id,class:p(["file-item",{uploading:"uploading"===a.status,success:"success"===a.status,error:"error"===a.status}])},[d("div",I,[d("div",B,[n(r(e),{icon:"material-symbols:description",width:"24",height:"24"})]),d("div",U,[d("div",V,c(a.name),1),d("div",D,c(Z(a.size)),1)])]),d("div",M,["uploading"===a.status?(i(),u("div",S,[d("div",T,[d("div",{class:"progress-fill",style:g({width:a.progress+"%"})},null,4)]),d("span",_,c(a.progress)+"%",1)])):(i(),u("div",j,["success"===a.status?(i(),u("span",E,"✓")):f("",!0),"error"===a.status?(i(),u("span",A,"✗")):f("",!0)])),d("div",G,["uploading"===a.status?(i(),u("button",{key:0,type:"button",class:"cancel-btn",onClick:e=>(e=>{const a=J.value.find(a=>a.id===e);a&&a.uploadId&&(window.$uploader?.cancel(a.uploadId),a.status="pending",a.progress=0,a.uploadId=void 0)})(a.id)}," 取消 ",8,K)):(i(),u("button",{key:1,type:"button",class:"remove-btn",onClick:e=>(e=>{const a=J.value.findIndex(a=>a.id===e);if(-1!==a){const e=J.value[a];"uploading"===e.status&&e.uploadId&&window.$uploader?.cancel(e.uploadId),J.value.splice(a,1);const l=J.value.map(e=>e.file);q("update:modelValue",l),q("file-remove",e.file)}})(a.id)}," 移除 ",8,L))])])],2))),128))])])):f("",!0),J.value.length>0&&!a.autoUpload?(i(),u("div",Q,[d("button",{type:"button",class:"upload-btn primary",disabled:N.value>0,onClick:ie},c(N.value>0?`上传中... (${N.value})`:"开始上传"),9,R),d("button",{type:"button",class:"upload-btn secondary",onClick:oe}," 取消 ")])):f("",!0)]))}}),[["__scopeId","data-v-720d47d1"]]);export{X as S};
