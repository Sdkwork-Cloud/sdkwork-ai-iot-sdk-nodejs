import{aG as e,aH as t,aI as r,aJ as s,aK as i}from"./index-3Iq02xX1.js";class o{player=null;volume=1;emitter=e();autoplayStatus=t.UNKNOWN;pendingPlayPromise=null;pendingPlayResolve=null;pendingPlayReject=null;config;constructor(e){this.config={decode:!1,sampleRate:16e3,realtime:!0,maxDelay:800,discardAll:!0,trafficImgUrl:"",channels:1,...e};try{this.initPlayer(),this.detectAutoplaySupport(),r.getInstance().onStatusChange(s.AUDIO,this.handleAutoplayStatusChange.bind(this))}catch(t){throw console.error("SdkworkStreamAudioPlayer 初始化失败:",t),t}}stop(){this.player.stop()}getVolume(){return this.volume}isRestartable(){return!0}initPlayer(){if(!i.BufferStreamPlayer)throw console.error("缺少BufferStreamPlayer扩展文件，请确保已导入 recorder-core/src/extensions/buffer_stream.player"),new Error("BufferStreamPlayer扩展未加载，请检查导入路径");try{i.TrafficImgUrl=this.config.trafficImgUrl,this.player=i.BufferStreamPlayer({decode:this.config.decode,sampleRate:this.config.sampleRate,realtime:this.config.realtime,maxDelay:this.config.maxDelay,discardAll:this.config.discardAll,TrafficImgUrl:this.config.trafficImgUrl,onInputError:(e,t)=>{console.error(`第${t}次的音频片段输入出错: ${e}`),this.emitter.emit("onError",new Error(`音频片段输入出错: ${e}`))},onPlayEnd:()=>{console.log("音频播放结束"),this.emitter.emit("onEnd",null)}}),console.log("流式音频播放器实例已创建，配置:",this.config)}catch(e){throw console.error("流式音频播放器初始化失败:",e),this.emitter.emit("onError",e instanceof Error?e:new Error(String(e))),e}}async detectAutoplaySupport(e=!1){const t=await r.getInstance().detectMediaSupport(s.AUDIO,e);return this.autoplayStatus=t.status,t}async requestAutoplayPermission(e=!1){const t=await r.getInstance().requestPermission(s.AUDIO,e);return this.autoplayStatus=t.status,t}handleAutoplayStatusChange(e){this.autoplayStatus=e.status,this.emitter.emit("onAutoplayStatusChange",e)}async start(e,r){if(!this.player)throw new Error("流式音频播放器未初始化，请先创建播放器实例");return void 0!==e&&(this.config.sampleRate=e),void 0!==r&&(this.config.channels=r),this.player&&this.player.isPause?(this.player.resume(),void this.emitter.emit("onPlay",null)):(console.error("start=============",this.player),this.autoplayStatus===t.UNKNOWN&&await this.detectAutoplaySupport(),new Promise((e,r)=>{try{if(this.autoplayStatus===t.ALLOWED)this.player.start(()=>{console.log("流式音频播放器已启动"),this.emitter.emit("onPlay",null),e()},e=>{console.error("流式音频播放器启动失败:",e),this.emitter.emit("onError",new Error(e)),r(new Error(e))});else if(this.autoplayStatus===t.ALLOWED_MUTED){const t=this.volume;this.setVolume(0),this.player.start(()=>{console.log("流式音频播放器已启动(静音模式)"),this.emitter.emit("onPlay",null);const r=()=>{this.setVolume(t),document.removeEventListener("click",r),document.removeEventListener("touchstart",r),document.removeEventListener("keydown",r)};document.addEventListener("click",r),document.addEventListener("touchstart",r),document.addEventListener("keydown",r),e()},e=>{console.error("流式音频播放器启动失败:",e),this.emitter.emit("onError",new Error(e)),r(new Error(e))})}else{const t={status:this.autoplayStatus,requiresUserInteraction:!0,requiresMuted:!1};this.emitter.emit("onAutoplayBlocked",t),this.pendingPlayPromise=new Promise((e,t)=>{this.pendingPlayResolve=e,this.pendingPlayReject=t});const s=e,i=r;this.pendingPlayPromise.then(()=>{s()}).catch(e=>{i(e)})}}catch(s){console.error("启动流式音频播放器失败:",s),this.emitter.emit("onError",s instanceof Error?s:new Error(String(s))),r(s)}}))}async resumeAfterInteraction(){try{if(!this.player)throw new Error("流式音频播放器未初始化");this.player.start(()=>{console.log("用户交互后流式音频播放器已启动"),this.emitter.emit("onPlay",null),this.pendingPlayResolve&&(this.pendingPlayResolve(),this.pendingPlayPromise=null,this.pendingPlayResolve=null,this.pendingPlayReject=null),this.autoplayStatus=t.ALLOWED},e=>{console.error("用户交互后流式音频播放器启动失败:",e),this.emitter.emit("onError",new Error(e)),this.pendingPlayReject&&(this.pendingPlayReject(new Error(e)),this.pendingPlayPromise=null,this.pendingPlayResolve=null,this.pendingPlayReject=null)})}catch(e){throw console.error("用户交互后恢复播放失败:",e),this.emitter.emit("onError",e instanceof Error?e:new Error(String(e))),e}}appendStreamData(e){if(this.player)try{this.player.input(e)}catch(t){console.error("添加音频数据失败:",t),this.emitter.emit("onError",t instanceof Error?t:new Error(String(t)))}else console.error("流式音频播放器未初始化，无法添加音频数据")}pause(e){if(this.player)try{this.player.pause(),e&&this.player.clearInput(),console.log("流式音频播放器已暂停"),this.emitter.emit("onPause",null)}catch(t){console.error("暂停流式音频播放器失败:",t),this.emitter.emit("onError",t instanceof Error?t:new Error(String(t)))}else console.error("流式音频播放器未初始化，无法暂停")}clearInput(e){if(this.player)try{this.player.clearInput(e),console.log("流式音频播放器输入已清空")}catch(t){console.error("清空流式音频播放器输入失败:",t),this.emitter.emit("onError",t instanceof Error?t:new Error(String(t)))}else console.error("流式音频播放器未初始化，无法清空输入")}async resume(e){if(this.player)try{e&&this.player.clearInput(),this.player.resume(),console.log("流式音频播放器已恢复"),this.emitter.emit("onPlay",null)}catch(t){throw console.error("恢复流式音频播放器失败:",t),this.emitter.emit("onError",t instanceof Error?t:new Error(String(t))),t}else console.error("流式音频播放器未初始化，无法恢复")}setVolume(e){this.player?(this.volume=Math.max(0,Math.min(1,e)),this.player.setVolume&&(this.player.setVolume(this.volume),this.emitter.emit("onVolumeChange",this.volume))):console.error("流式音频播放器未初始化，无法设置音量")}isPlayable(){return!!this.player&&(!this.isPause()&&!this.isStop())}isPlaying(){return!!this.player&&(!this.player.isStop&&!this.player.isPause&&!this.player.isPlayEnd)}isStop(){return!this.player||this.player.isStop}isPause(){return!!this.player&&this.player.isPause}isPlayEnd(){return!!this.player&&this.player.isPlayEnd}getCurrentTime(){return this.player&&this.player.currentTime||0}on(e,t){this.emitter.on(e,t)}off(e){this.emitter.off(e)}destroy(){try{this.stop(),this.player&&this.player.destroy&&this.player.destroy(),this.player=null,this.emitter.all.clear()}catch(e){console.error("销毁流式音频播放器失败:",e)}}}export{o as S};
