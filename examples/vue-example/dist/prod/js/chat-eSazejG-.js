const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/iot-handler-BhrLd4gu.js","js/index-cvC_tnhK.js","js/vue-vendor-Caw1HGjZ.js","js/utils-vendor-WEzSe-CR.js","css/index-D4l5L7TK.css","js/conversation-C9A_VfvY.js","js/sdkwork_stream_player-B08I9Xf0.js","js/sse-handler-F89VnTRm.js","js/im-handler-C9iaQUFd.js"])))=>i.map(i=>d[i]);
import{z as e}from"./vue-vendor-Caw1HGjZ.js";import{x as t,M as a,y as s,k as i,j as r,h as n,aD as o,aE as d,aF as c,g as l}from"./index-cvC_tnhK.js";import{u as h}from"./conversation-C9A_VfvY.js";import{S as g}from"./sdkwork_stream_player-B08I9Xf0.js";class m extends t.BaseService{constructor(){super(a.create(s.ChatMessageManager))}async loadMore(e,t,a){const s=await this.manager.loadMore(e,t,a);return null==s||null==s.data?Promise.reject(new Error("data error!")):s.data}}var u=(e=>(e.SENDING="sending",e.SENT="sent",e.FAILED="failed",e.DELIVERED="delivered",e))(u||{});const y=e("message",{state:()=>({loading:!1,error:null,initialized:!1,messages:[],currentPage:1,pageSize:20,hasMore:!0,totalCount:0,streaming:!1,currentStream:null,toolCalls:[],toolResults:[]}),getters:{isLoading:e=>e.loading,getError:e=>e.error,isInitialized:e=>e.initialized,currentMessages:e=>e.messages,messageCount:e=>e.messages.length,lastMessage:e=>e.messages[e.messages.length-1]||null,isStreaming:e=>e.streaming,hasActiveToolCalls:e=>e.toolCalls.length>0,sortedMessages:e=>[...e.messages].sort((e,t)=>(e.sendAt?window.$date.parse(e.sendAt).getTime():0)-(t.sendAt?window.$date.parse(t.sendAt).getTime():0)),unreadCount:e=>e.messages.filter(e=>!e.readAt).length,sendingMessages:e=>e.messages.filter(e=>e.metadata?.get?.("sendStatus")===u.SENDING),failedMessages:e=>e.messages.filter(e=>e.metadata?.get?.("sendStatus")===u.FAILED),getCurrentPage:e=>e.currentPage,getPageSize:e=>e.pageSize,getHasMore:e=>e.hasMore,getTotalCount:e=>e.totalCount},actions:{async initialize(){try{this.loading=!0,this.initialized=!0}catch(e){throw this.error=e,e}finally{this.loading=!1}},async loadMessages(e){try{this.loading=!0;const t=new m,a={},s=h().currentConversation;s?(s.id&&(a.conversationId=s.id),s.uuid&&(a.conversationUuid=s.uuid)):a.conversationId=e.conversationId,void 0!==e.page&&(a.page=e.page),void 0!==e.size&&(a.size=e.size);const i=await t.listByPage(a);this.messages=i.content||[]}catch(t){throw this.error=t,t}finally{this.loading=!1}},async loadMoreMessages(e){try{this.loading=!0;const t=new m,a={},s=h().currentConversation;if(s?(s.id&&(a.conversationId=s.id),s.uuid&&(a.conversationUuid=s.uuid)):a.conversationId=e.conversationId,e.lastSyncMessageId)a.lastSyncMessageId=e.lastSyncMessageId;else if(this.messages.length>0){const e=this.messages[0];e&&e.id&&(a.lastSyncMessageId=e.id)}void 0!==e.page&&(a.page=e.page),void 0!==e.size&&(a.size=e.size);const i=await t.loadMore(a);this.messages=[...this.messages,...i.content||[]]}catch(t){throw this.error=t,t}finally{this.loading=!1}},async saveMessage(e,t){const a=i.messageToVO(e);this.saveMessageVO(a,t)},async saveMessageVO(e,t){try{this.loading=!0,e.uuid||(e.uuid=window.$uuid()),e.sendAt||(e.sendAt=window.$date.format(new Date));const a=n().currentUser;return e.sender&&e.senderId||a&&(!e.senderId&&a.id&&(e.senderId=a.id),e.sender||(e.sender={id:a.id,name:a.nickname||a.username,uuid:a.uuid})),this.setMessageSendStatus(e,u.SENDING),t&&(e.metadata=e.metadata||new Map,e.metadata.set("chatContext",t)),e.senderId&&e.senderId===a?.id&&(e.isOwn=!0),this.messages.push(e),window.dispatchEvent(new CustomEvent("sdk:messageSent",{detail:{type:"GENERIC_MESSAGE_SENT",message:e,chatContext:t}})),e}catch(a){throw this.error=a,a}finally{this.loading=!1}},handleReceivedMessage(e){const t={id:e.id,content:e.content,role:r.MessageRole.ASSISTANT,isOwn:!1,timestamp:e.timestamp,sender:e.sender,metadata:e.metadata};this.messages.push(t),window.dispatchEvent(new CustomEvent("sdk:message",{detail:{type:"MESSAGE_RECEIVED",message:t}}))},handleReceivedAudioStream(e){window.dispatchEvent(new CustomEvent("sdk:audioStream",{detail:{type:"AUDIO_STREAM_RECEIVED",audio:e}}))},convertRoleToEnum(e){if(!e)return;switch(e.toUpperCase()){case"USER":return r.MessageRole.USER;case"ASSISTANT":return r.MessageRole.ASSISTANT;case"SYSTEM":return r.MessageRole.SYSTEM;case"FUNCTION":return r.MessageRole.FUNCTION;case"DEFAULT":return r.MessageRole.DEFAULT;default:return}},handleReceivedChunk(e){try{const{channelMsgId:t,id:a,chunk:s}=e;if(!s)return;this.streaming=!0;const i=void 0!==s.choices?.[0]?.finish_reason&&null!==s.choices[0].finish_reason,n=s.choices?.[0]?.delta,o=n?.reasoning_content||"",d=this.convertRoleToEnum(n?.role)||r.MessageRole.ASSISTANT;let c=this.messages.find(e=>e.channelMsgId===t||e.id===a||e.uuid===a);if(c){if(o&&(c.reasoning_content=(c.reasoning_content||"")+o),c.messageState&&(c.messageState.isThinking=!!o,i&&c.messageState.isThinking&&(c.messageState.thinkEnd=Date.now())),c.body?.groups){const e=c.body.groups.get(t)||[];e.push(s),c.body.groups.set(t,e)}}else c={id:a||window.$uuid(),uuid:window.$uuid(),channelMsgId:t,reasoning_content:o||"",type:r.MessageType.TEXT,role:d,isOwn:!1,sendAt:window.$date.format(new Date),createdAt:window.$date.format(new Date),metadata:new Map([["streaming",!0],["isFinal",!1],["chunkCount",1]]),children:[],messageState:{isThinking:!!s.choices?.[0]?.delta?.reasoning_content,thinkStart:Date.now(),thinkEnd:void 0},actions:s.metadata?.actions||[],errorCode:void 0,receiveAt:void 0,modelId:s.model?parseInt(s.model):void 0,model:s.model,chatOptions:void 0,parentMessageId:s.metadata?.parent_message_id,temperature:void 0,receiverId:void 0,isError:!1,senderId:void 0,usedRag:!1,processingTime:void 0,userId:void 0,readAt:void 0,tokenCount:s.usage?.total_tokens,errorMessage:void 0,body:{id:s.id,groups:new Map([[t,[s]]]),completion:void 0,payload:void 0,thinkStart:void 0,thinkEnd:void 0}},this.messages.push(c);return c.body?.groups?.get(t)&&1!==c.body.groups.get(t)?.length?window.dispatchEvent(new CustomEvent("sdk:message",{detail:{type:"MESSAGE_STREAM_UPDATE",message:c,chunk:s}})):window.dispatchEvent(new CustomEvent("sdk:message",{detail:{type:"MESSAGE_RECEIVED",message:c}})),c}catch(t){throw this.streaming=!1,t}},setMessageSendStatus(e,t){e.metadata=e.metadata||new Map,e.metadata.set("sendStatus",t),e.metadata.set("sendTimestamp",Date.now()),t===u.FAILED&&e.metadata.set("sendError","消息发送失败")},updateMessageSendStatus(e,t,a){const s=this.messages.find(t=>t.id===e||t.uuid===e);s&&(this.setMessageSendStatus(s,t),a&&s.metadata?.set("sendError",a))},async markMessageAsRead(e){const t=this.messages.find(t=>t.id===e||t.uuid===e);t&&(t.readAt=window.$date.format(new Date))},async deleteMessage(e){try{this.loading=!0,this.messages=this.messages.filter(t=>t.id!==e&&t.uuid!==e)}catch(t){throw this.error=t,t}finally{this.loading=!1}},async clearMessages(e){try{this.loading=!0,this.messages=e?this.messages.filter(t=>t.conversationId!==e):[]}catch(t){throw this.error=t,t}finally{this.loading=!1}},async searchMessages(e,t){try{this.loading=!0;let a=this.messages;t&&(a=a.filter(e=>e.conversationId===t));return a.filter(t=>{const a=i.getText(t);return!!a&&a.includes(e.toLowerCase())})}catch(a){throw this.error=a,a}finally{this.loading=!1}},getLastMessageByConversation(e){const t=this.messages.filter(t=>t.conversationId===e);return t[t.length-1]||null},getMessageCountByConversation(e){return this.messages.filter(t=>t.conversationId===e).length},reset(){this.messages=[],this.streaming=!1,this.currentStream=null,this.toolCalls=[],this.toolResults=[]}}});var p=(e=>(e.IOT="iot",e.SSE="sse",e.IM="im",e))(p||{});class E{async createHandler(e,t){switch(e){case p.IOT:return await this.createIotHandler(t);case p.SSE:return this.createSseHandler(t);case p.IM:return this.createImHandler(t);default:throw new Error(`不支持的消息处理器类型: ${e}`)}}async createIotHandler(e){const{IotMessageHandler:t}=await o(async()=>{const{IotMessageHandler:e}=await import("./iot-handler-BhrLd4gu.js");return{IotMessageHandler:e}},__vite__mapDeps([0,1,2,3,4,5,6]));return new t(e.config,e.eventEmitter,e.eventAdapter)}async createSseHandler(e){const{SseMessageHandler:t}=await o(async()=>{const{SseMessageHandler:e}=await import("./sse-handler-F89VnTRm.js");return{SseMessageHandler:e}},__vite__mapDeps([7,1,2,3,4,5,6]));return new t(e.config,e.eventEmitter,e.eventAdapter)}async createImHandler(e){const{ImMessageHandler:t}=await o(async()=>{const{ImMessageHandler:e}=await import("./im-handler-C9iaQUFd.js");return{ImMessageHandler:e}},__vite__mapDeps([8,1,2,3,4]));return new t(e.config)}}class w{static toCompletionParam(e){let t=window.$chat.getTextFromPayload(e.body?.payload);return{messages:[{role:r.ChatCompletionRole.user,content:t}],stream:!0}}static toCompletionChunk(e,t){return{id:t.id,object:"chat.completion.chunk",created:t.created,model:t.model,choices:[{index:0,delta:{role:"assistant",content:e}}]}}static createMessage(e,t){const{messageType:a}=t;switch(a){case r.MessageType.TEXT:return this.createTextMessage(e,t);case r.MessageType.AUDIO:if(e.url)return this.createAudioMessageByUrl(e,t);if(e.file)return this.createAudioMessage(e,t);break;case r.MessageType.IMAGE:if(e.url)return this.createImageMessageByUrl(e,t);if(e.file)return this.createImageMessage(e,t);break;case r.MessageType.VIDEO:if(e.url)return this.createVideoMessageByUrl(e,t);if(e.file)return this.createVideoMessage(e,t);break;case r.MessageType.FILE:if(e.url)return this.createFileMessageByUrl(e,t);if(e.file)return this.createFileMessage(e,t);break;case r.MessageType.LOCATION:if(void 0!==e.latitude&&void 0!==e.longitude)return this.createLocationMessage(e,t);break;case r.MessageType.MUSIC:if(e.title&&e.artist&&e.url)return this.createMusicMessage(e,t)}throw new Error(`不支持的消息类型: ${a} 或缺少必要的参数`)}static createTextMessage(e,t){const a={text:{content:e.content}},s=this.createBaseMessageBody(a);return{...this.createCommonPart(t,r.MessageType.TEXT,s)}}static createAudioMessageByUrl(e,t){const a={audio:{content:e.content,resource:{url:e.url,duration:e.duration}}},s=this.createBaseMessageBody(a);return{...this.createCommonPart(t,r.MessageType.AUDIO,s)}}static createAudioMessage(e,t){const a=this.fileToDataURL(e.file,e.format||"wav"),s={audio:{content:e.content,resource:{url:a,duration:e.duration,localFile:e.file,format:e.format}}},i=this.createBaseMessageBody(s);return{...this.createCommonPart(t,r.MessageType.AUDIO,i)}}static createImageMessageByUrl(e,t){const a={image:{content:e.content,resource:{url:e.url,width:e.width,height:e.height,name:e.name,extension:e.extension}}},s=this.createBaseMessageBody(a);return{...this.createCommonPart(t,r.MessageType.IMAGE,s)}}static createImageMessage(e,t){const a=this.fileToDataURL(e.file,"image"),s={image:{content:e.content,resource:{url:a,width:e.width,height:e.height,name:e.name,extension:e.extension,localFile:e.file}}},i=this.createBaseMessageBody(s);return{...this.createCommonPart(t,r.MessageType.IMAGE,i)}}static createVideoMessageByUrl(e,t){const a={video:{content:e.content,resource:{url:e.url,duration:e.duration,size:e.size,name:e.name,extension:e.extension}}},s=this.createBaseMessageBody(a);return{...this.createCommonPart(t,r.MessageType.VIDEO,s)}}static createVideoMessage(e,t){const a=this.fileToDataURL(e.file,"video"),s={video:{content:e.content,resource:{url:a,duration:e.duration,localFile:e.file}}},i=this.createBaseMessageBody(s);return{...this.createCommonPart(t,r.MessageType.VIDEO,i)}}static createFileMessageByUrl(e,t){const a={file:{content:e.content,resource:{url:e.url,size:e.size,name:e.name,extension:e.extension}}},s=this.createBaseMessageBody(a);return{...this.createCommonPart(t,r.MessageType.FILE,s)}}static createFileMessage(e,t){const a=this.fileToDataURL(e.file,e.mimeType||"application/octet-stream"),s=e.file instanceof Blob||e.file instanceof File?e.file.size:e.file.byteLength,i={file:{content:e.content,resource:{url:a,size:s,name:e.name,extension:e.extension,localFile:e.file}}},n=this.createBaseMessageBody(i);return{...this.createCommonPart(t,r.MessageType.FILE,n)}}static createLocationMessage(e,t){const a={latitude:e.latitude,longitude:e.longitude},s={location:{content:e.address||"",location:a}},i=this.createBaseMessageBody(s);return{...this.createCommonPart(t,r.MessageType.LOCATION,i)}}static createMusicMessage(e,t){const a={text:{content:`${e.title} - ${e.artist}`}},s=this.createBaseMessageBody(a),i=new Map;t.metadata&&t.metadata.forEach((e,t)=>i.set(t,e)),i.set("music",{title:e.title,artist:e.artist,album:e.album,duration:e.duration,url:e.url,cover:e.cover});return{...this.createCommonPart({...t,metadata:i},r.MessageType.TEXT,s)}}static createChatCompletionMessage(e,t){const a={text:{content:e.content}},s=this.createBaseMessageBody(a);return{...this.createCommonPart(t,r.MessageType.TEXT,s)}}static createChatCompletionChunk(e,t){const a={text:{content:e.content}},s=this.createBaseMessageBody(a);return{...this.createCommonPart(t,r.MessageType.TEXT,s)}}static fromRawData(e,t){let a;a=e.content&&e.content.payload||e.content&&e.content.completion?e.content:e.content||{thinkStart:Date.now(),thinkEnd:Date.now()};const s=this.createCommonPart(t,t.messageType,a);return{...e,...s,uuid:e.uuid||s.uuid,createdAt:e.createdAt||s.createdAt,updatedAt:e.updatedAt||s.updatedAt}}static validateMessage(e){if(!e.type||!e.body)return!1;const t=e.body;return t.payload?this.validateIMMessage(e):!t.completion||this.validateChatMessage(e)}static validateIMMessage(e){const t=e.body;if(!t.payload)return!1;const a=t.payload;return!!(a.text||a.audio||a.image||a.video||a.file||a.location||a.music)}static validateChatMessage(e){return!!e.body.completion}static createBaseMessageBody(e){return{payload:e,thinkStart:Date.now(),thinkEnd:Date.now()}}static createCommonPart(e,t,a){const s=window.$date.format(new Date),i=this.mapChatContextFields(e.context);return{uuid:window.$uuid(),type:t,body:a,conversationId:e.conversationId,sendAt:s,metadata:e.metadata,createdAt:s,updatedAt:s,...i}}static mapChatContextFields(e){if(!e)return{};const t={};return Object.entries({conversation_id:"conversationId",user_id:e=>({userId:e.toString()}),knowledge_base_id:"knowledgeBaseId",agent_id:"agentId",flow_id:"flowId",datasource_id:"datasourceId",indent:"indent",parent_message_id:"parentMessageId",save_audio:"saveAudio"}).forEach(([a,s])=>{const i=e[a];null!=i&&("function"==typeof s?Object.assign(t,s(i)):t[s]=i)}),t}static fileToDataURL(e,t){if(e instanceof ArrayBuffer){return`data:${t};base64,${btoa(String.fromCharCode(...new Uint8Array(e)))}`}return Blob,URL.createObjectURL(e)}}const M=e("chat",{state:()=>({loading:!1,error:null,initialized:!1,options:{model:void 0,temperature:.7,max_tokens:2e3,top_p:1,frequency_penalty:0,presence_penalty:0,stream:!0,modalities:["text","audio"]},currentHandlerType:p.IOT,messageHandler:null,audioParams:{sample_rate:16e3,channels:1,format:"opus",frame_duration:60},_streamPlayer:null,speakState:"IDLE",currentChatMode:null,_audioStreamLogCounter:0,_isRecreatingPlayer:!1}),getters:{isLoading:e=>e.loading,getError:e=>e.error,isInitialized:e=>e.initialized,currentOptions:e=>e.options,currentMessageHandler:e=>e.messageHandler,isSpeaking:e=>"SPEAKING"===e.speakState,isListening:e=>"LISTENING"===e.speakState,isIdle:e=>"IDLE"===e.speakState},actions:{async initialize(){try{this.loading=!0,await this.initializeMessageHandler(),this.initialized=!0}catch(e){this.error=e}finally{this.loading=!1}},async initializeMessageHandler(){try{const e={config:await this.getIotConfig(),eventEmitter:this.createEventEmitter(),eventAdapter:this.createEventAdapter()},t=new E;this.messageHandler=await t.createHandler(this.currentHandlerType||p.IOT,e),await(this.messageHandler?.initialize())}catch(e){this.error=e}},async enterChat(e={}){try{this.loading=!0;const{mode:t="text",forceReconnect:a=!1}=e;switch(this.messageHandler?this.messageHandler.isConnected():await this.initializeMessageHandler(),await this.createStreamPlayer(),t){case"voice":await this.initVoiceRoom();break;case"rtc":await this.initRtcRoom()}await this.loadCurrentConversationMessages(),this.currentChatMode=t}catch(t){this.error=t}finally{this.loading=!1}},async exitChat(){try{this.loading=!0;switch(this.currentChatMode){case"voice":await this.exitVoiceRoom();break;case"rtc":await this.exitRtcRoom()}this.stopVoiceListening(),this._streamPlayer&&(await this._streamPlayer.stopStream(),this._streamPlayer.destroy(),this._streamPlayer=null),this.stopListeningToRecorderStream(),this.speakState="IDLE",this.currentChatMode=null}catch(e){this.error=e}finally{this.loading=!1}},async switchChatMode(e){try{this.loading=!0;const t=this.currentChatMode;if(t)switch(t){case"voice":await this.exitVoiceRoom();break;case"rtc":await this.exitRtcRoom()}switch(e){case"voice":await this.initVoiceRoom();break;case"rtc":await this.initRtcRoom()}this.currentChatMode=e}catch(t){this.error=t}finally{this.loading=!1}},async initVoiceRoom(){try{this.listenToRecorderStream()}catch(e){}},async initRtcRoom(){},async enterVoiceRoom(e={}){let t=!1;try{if(this._streamPlayer&&this._streamPlayer.clearInput(),e.hello?.send)try{await this.sendHello(e.hello?.text||"")}catch(a){}const{enableWave:i=!0,waveContainer:r=null,sampleRate:n=16e3,format:o="pcm",realtime:d=!0}=e,c=l();r&&i&&c.setWaveContainer(r);try{await c.startRecording({realtime:d,enableWave:i,waveContainer:r,sampleRate:n,format:o}),t=!0}catch(s){this.error=s}}catch(s){this.error=s}return{recorderInitialized:t}},async exitVoiceRoom(){try{const e=l();await e.stopRecording(),e.destroyRecorder()}catch(e){}},async enterRtcRoom(){},async exitRtcRoom(){},async loadCurrentConversationMessages(){try{const e=h(),t=y(),a=e.currentConversation;if(!a)return;await t.loadMessages({conversationId:a.id||a.uuid,page:1,size:20})}catch(e){}},async createStreamPlayer(){try{return this._streamPlayer&&(await this._streamPlayer.stopStream(),this._streamPlayer.destroy(),this._streamPlayer=null),this._streamPlayer=new g,await this._streamPlayer.startStream(this.audioParams?.sample_rate,this.audioParams?.channels),this._streamPlayer}catch(e){throw this._streamPlayer=null,e}},async switchHandlerType(e){try{this.loading=!0,this.messageHandler&&(await this.messageHandler.destroy(),this.messageHandler=null),this.currentHandlerType=e,await this.initializeMessageHandler()}catch(t){this.error=t}finally{this.loading=!1}},getDeviceInfo(){let e=localStorage.getItem("sdkwork-device-id");return e||(e=(()=>{const e=[navigator.userAgent,navigator.language,navigator.hardwareConcurrency||"",screen.width,screen.height,screen.colorDepth,(new Date).getTimezoneOffset()].join("|");let t=0;for(let a=0;a<e.length;a++)t=(t<<5)-t+e.charCodeAt(a),t&=t;return`web-device-${Math.abs(t).toString(36)}`})(),localStorage.setItem("sdkwork-device-id",e)),{deviceId:e,deviceType:"web",userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,screenResolution:`${screen.width}x${screen.height}`,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone}},async getIotConfig(){const e=this.getDeviceInfo(),t=n().token||"your-auth-token",a=`${e.deviceId}-${Date.now()}-${Math.random().toString(36).substring(2,9)}`;return{deviceId:e.deviceId,clientId:a,authorization:t,baseUrl:c.websocketBaseURL,transport:"websocket",protocol:"sdkwork",timeout:3e4,maxRetries:5,debug:!0,logLevel:"info",apiKey:void 0,authType:void 0,audioParams:{format:"opus",sample_rate:16e3,channels:1,frame_duration:60},features:void 0}},createEventEmitter(){return{emit:e=>{this.handleEvent(e)}}},createEventAdapter:()=>({adaptConnectionChange:e=>({type:"CONNECTION_CHANGE",state:e}),adaptMessageReceived:e=>({type:"MESSAGE_RECEIVED",message:e}),adaptMessageChunkReceived:e=>({type:"MESSAGE_CHUNK_RECEIVED",message:e}),adaptAudioStreamReceived:e=>({type:"AUDIO_STREAM_RECEIVED",audio:e}),adaptDataReceived:e=>({type:"DATA_RECEIVED",data:e}),adaptToolCallReceived:e=>({type:"TOOL_CALL_RECEIVED",tool:e}),adaptErrorOccurred:e=>({type:"ERROR_OCCURRED",error:e}),adaptIotEventReceived:(e,t)=>({type:"IOT_EVENT_RECEIVED",eventType:e,event:t})}),handleEvent(e){const t=y();switch(e.type){case"CONNECTION_CHANGE":case"DATA_RECEIVED":case"TOOL_CALL_RECEIVED":case"IOT_EVENT_RECEIVED":default:break;case"MESSAGE_RECEIVED":t.handleReceivedMessage(e.message);break;case"MESSAGE_CHUNK_RECEIVED":t.handleReceivedChunk(e.message);break;case"AUDIO_STREAM_RECEIVED":this._audioStreamLogCounter++,this._audioStreamLogCounter;const a=e.audio.data;if(a.channelData){const e=a.channelData[0];if(!e||!e.length)return;this._streamPlayer&&(this._streamPlayer.isPlayable()?this._streamPlayer.appendStreamData(e):this.createStreamPlayer().then(()=>{this._streamPlayer?.appendStreamData(e)}).catch(e=>{}))}t.handleReceivedAudioStream(e.audio);break;case"ERROR_OCCURRED":this.error=e.error}},async sendHello(e,t){const a=h().getOrCreateChatContext(t);a&&(a.chat_options=this.options);const s=a?this.filterContext(a):this.createDefaultChatContext();this.messageHandler?.sendHello(e,{chatContext:s,audioParams:this.audioParams})},async sendText(e,t){const a=h().getOrCreateChatContext(t);a&&(a.chat_options=this.options);const s=a?this.filterContext(a):this.createDefaultChatContext(),i=w.createTextMessage({content:e},{messageType:r.MessageType.TEXT,context:s});return this.sendMessage(i,s)},async sendMessage(e,t){try{this.loading=!0,await this.ensurePlayerReady();const a=h().getOrCreateChatContext(t);a&&(a.chat_options=this.options);const s=a?this.filterContext(a):this.createDefaultChatContext(),i=y();if(await i.saveMessage(e,s),!this.messageHandler)return;return this.messageHandler.send(e,t||this.createDefaultChatContext()),e.uuid}catch(a){this.error=a}finally{this.loading=!1}},async sendAudioStream(e,t){try{if(this.loading=!0,!this.messageHandler||!this.messageHandler.isConnected())return;const a=h().getOrCreateChatContext(t);a&&(a.chat_options=this.options);a?this.filterContext(a):this.createDefaultChatContext();let s;s=e instanceof Blob?await e.arrayBuffer():e,this.messageHandler.sendAudioStream&&this.messageHandler.sendAudioStream(e,1,t||this.createDefaultChatContext())}catch(a){this.error=a}finally{this.loading=!1}},filterContext(e,t){const a={...e};return t&&Object.assign(a,t),a},async ensurePlayerReady(){if(!this._streamPlayer)return void(await this.createStreamPlayer());switch(this._streamPlayer.getState()){case d.ERROR:await this.restartPlayer();break;case d.IDLE:await this._streamPlayer.startStream(this.audioParams?.sample_rate,this.audioParams?.channels);break;case d.ENDED:await this.restartPlayer();break;case d.READY:case d.PLAYING:case d.PAUSED:break;default:await this.restartPlayer()}},async restartPlayer(){if(!this._isRecreatingPlayer)try{if(this._isRecreatingPlayer=!0,this._streamPlayer&&this._streamPlayer.isRestartable()){await this._streamPlayer.stopStream(),await new Promise(e=>setTimeout(e,300));const e=this._streamPlayer.getState();e!==d.IDLE&&e!==d.ERROR?await this.createStreamPlayer():await this._streamPlayer.startStream(this.audioParams?.sample_rate,this.audioParams?.channels)}}catch(e){try{await this.createStreamPlayer()}catch(t){}}finally{this._isRecreatingPlayer=!1}},async startPlayer(){try{this._streamPlayer&&await this._streamPlayer.startStream(this.audioParams?.sample_rate,this.audioParams?.channels)}catch(e){}},startVoiceListening(){this.messageHandler&&this.messageHandler.isConnected()&&this.messageHandler.startListening()},stopVoiceListening(){this.messageHandler&&this.messageHandler.isConnected()&&this.messageHandler.stopListening()},reset(){this.messageHandler=null,this.speakState="IDLE"},async cleanup(){try{this.stopVoiceListening(),this.stopListeningToRecorderStream(),this._streamPlayer&&(await this._streamPlayer.stopStream(),this._streamPlayer.destroy(),this._streamPlayer=null),this.reset(),this.error=null,this.initialized=!1}catch(e){}},setSpeakState(e){this.speakState=e},setSpeaking(){this.speakState="SPEAKING"},setListening(){this.speakState="LISTENING"},setIdle(){this.speakState="IDLE"},listenToRecorderStream(){window.$on&&window.$on("recorder:stream-data",this.handleRecorderStreamData.bind(this))},handleRecorderStreamData(e){try{if(!this.messageHandler)return;if(!this.messageHandler?.isConnected())return;this.sendAudioStream(e)}catch(t){}},stopListeningToRecorderStream(){window.$off&&window.$off("recorder:stream-data",this.handleRecorderStreamData)},createDefaultChatContext(){const e=h().currentConversationId;return{conversation_id:e||void 0,conversation_uuid:e||void 0}}}});export{w as M,M as a,y as u};
