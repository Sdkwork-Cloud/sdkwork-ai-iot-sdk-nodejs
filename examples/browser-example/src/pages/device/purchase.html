<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备购买 - SDKWork AIoT</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vant@4/lib/index.css">
    <link rel="stylesheet" href="../../assets/styles/main.css">
</head>
<body>
    <div id="app">
        <app-header title="设备购买" show-back></app-header>
        
        <main class="purchase-content">
            <!-- 设备信息 -->
            <div class="device-info">
                <van-image
                    width="100%"
                    height="200"
                    :src="device.image"
                    fit="cover"
                    class="device-image"
                />
                <div class="device-details">
                    <h2 class="device-name">{{ device.name }}</h2>
                    <p class="device-description">{{ device.description }}</p>
                    <div class="device-price">
                        <span class="price">¥{{ device.price }}</span>
                        <span class="original-price" v-if="device.originalPrice">¥{{ device.originalPrice }}</span>
                    </div>
                </div>
            </div>
            
            <!-- 购买选项 -->
            <van-cell-group title="购买选项">
                <van-cell title="购买数量">
                    <template #value>
                        <van-stepper v-model="quantity" :min="1" :max="10" />
                    </template>
                </van-cell>
                
                <van-cell title="服务期限">
                    <template #value>
                        <van-radio-group v-model="servicePeriod" direction="horizontal">
                            <van-radio name="1year">1年</van-radio>
                            <van-radio name="2year">2年</van-radio>
                            <van-radio name="3year">3年</van-radio>
                        </van-radio-group>
                    </template>
                </van-cell>
            </van-cell-group>
            
            <!-- 价格计算 -->
            <van-cell-group>
                <van-cell title="商品金额" :value="`¥${device.price * quantity}`" />
                <van-cell title="服务费用" value="¥0" />
                <van-cell title="合计金额" :value="`¥${totalAmount}`" class="total-amount" />
            </van-cell-group>
            
            <!-- 购买按钮 -->
            <div class="purchase-actions">
                <van-button 
                    type="primary" 
                    size="large" 
                    block 
                    @click="handlePurchase"
                    :loading="purchasing"
                >
                    立即购买 ¥{{ totalAmount }}
                </van-button>
            </div>
        </main>
    </div>

    <script type="module">
        import { createApp, ref, computed } from 'https://cdn.jsdelivr.net/npm/vue@3/dist/vue.esm-browser.js'
        import { tradeStore } from '../../stores/trade-store.js'
        
        const app = createApp({
            setup() {
                const device = ref({
                    id: 'device-001',
                    name: 'AIoT智能设备',
                    description: '支持语音交互、智能控制的AIoT设备',
                    price: 299,
                    originalPrice: 399,
                    image: '../../assets/images/device-sample.jpg'
                })
                
                const quantity = ref(1)
                const servicePeriod = ref('1year')
                const purchasing = ref(false)
                
                // 计算总金额
                const totalAmount = computed(() => {
                    return device.value.price * quantity.value
                })
                
                // 处理购买
                const handlePurchase = async () => {
                    purchasing.value = true
                    
                    try {
                        const orderData = {
                            deviceId: device.value.id,
                            quantity: quantity.value,
                            servicePeriod: servicePeriod.value,
                            totalAmount: totalAmount.value
                        }
                        
                        const result = await tradeStore().createOrder(orderData)
                        
                        // 跳转到支付页面
                        window.location.href = `../trade/payment.html?orderId=${result.orderId}`
                    } catch (error) {
                        console.error('购买失败:', error)
                        vanDialog.alert({
                            title: '购买失败',
                            message: error.message || '请稍后重试'
                        })
                    } finally {
                        purchasing.value = false
                    }
                }
                
                return {
                    device,
                    quantity,
                    servicePeriod,
                    purchasing,
                    totalAmount,
                    handlePurchase
                }
            }
        })
        
        app.component('app-header', window.AppHeader)
        app.mount('#app')
    </script>
</body>
</html>