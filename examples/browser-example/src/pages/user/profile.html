<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人信息 - SDKWork AIoT</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vant@4/lib/index.css">
    <link rel="stylesheet" href="../../assets/styles/main.css">
</head>
<body>
    <div id="app">
        <app-header title="个人信息" show-back></app-header>
        
        <main class="profile-content">
            <!-- 头像设置 -->
            <van-cell-group>
                <van-cell title="头像" center>
                    <template #value>
                        <van-uploader 
                            v-model="avatarFileList" 
                            :max-count="1"
                            :after-read="handleAvatarUpload"
                        >
                            <van-image
                                round
                                width="60"
                                height="60"
                                :src="userInfo.avatar || '../../assets/images/default-avatar.png'"
                                class="avatar-preview"
                            />
                        </van-uploader>
                    </template>
                </van-cell>
            </van-cell-group>
            
            <!-- 基本信息 -->
            <van-form @submit="handleSave" class="profile-form">
                <van-cell-group title="基本信息">
                    <van-field
                        v-model="form.nickname"
                        label="昵称"
                        placeholder="请输入昵称"
                        :rules="[{ required: true, message: '请输入昵称' }]"
                    />
                    
                    <van-field
                        v-model="form.mobile"
                        label="手机号"
                        placeholder="请输入手机号"
                        type="tel"
                        :rules="[{ required: true, message: '请输入手机号' }]"
                    />
                    
                    <van-field
                        v-model="form.email"
                        label="邮箱"
                        placeholder="请输入邮箱"
                        type="email"
                    />
                    
                    <van-field
                        v-model="form.birthday"
                        label="生日"
                        placeholder="请选择生日"
                        readonly
                        @click="showBirthdayPicker = true"
                    />
                    
                    <van-field
                        v-model="form.gender"
                        label="性别"
                        placeholder="请选择性别"
                        readonly
                        @click="showGenderPicker = true"
                    />
                </van-cell-group>
                
                <!-- 保存按钮 -->
                <div class="form-actions">
                    <van-button 
                        type="primary" 
                        size="large" 
                        block 
                        native-type="submit"
                        :loading="saving"
                    >
                        保存修改
                    </van-button>
                </div>
            </van-form>
        </main>
        
        <!-- 生日选择器 -->
        <van-popup v-model:show="showBirthdayPicker" position="bottom">
            <van-date-picker
                v-model="birthdayDate"
                title="选择生日"
                :min-date="minDate"
                :max-date="maxDate"
                @confirm="onBirthdayConfirm"
                @cancel="showBirthdayPicker = false"
            />
        </van-popup>
        
        <!-- 性别选择器 -->
        <van-popup v-model:show="showGenderPicker" position="bottom">
            <van-picker
                :columns="genderColumns"
                @confirm="onGenderConfirm"
                @cancel="showGenderPicker = false"
            />
        </van-popup>
    </div>

    <script type="module">
        import { createApp, ref, onMounted } from 'https://cdn.jsdelivr.net/npm/vue@3/dist/vue.esm-browser.js'
        import { userStore } from '../../stores/user-store.js'
        
        const app = createApp({
            setup() {
                const userInfo = ref({})
                const form = ref({
                    nickname: '',
                    mobile: '',
                    email: '',
                    birthday: '',
                    gender: ''
                })
                
                const avatarFileList = ref([])
                const saving = ref(false)
                const showBirthdayPicker = ref(false)
                const showGenderPicker = ref(false)
                
                const birthdayDate = ref([])
                const minDate = new Date(1900, 0, 1)
                const maxDate = new Date()
                
                const genderColumns = [
                    { text: '男', value: 'male' },
                    { text: '女', value: 'female' },
                    { text: '保密', value: 'secret' }
                ]
                
                // 加载用户信息
                const loadUserInfo = async () => {
                    try {
                        const info = await userStore().getUserInfo()
                        userInfo.value = info
                        
                        // 填充表单
                        form.value = {
                            nickname: info.nickname || '',
                            mobile: info.mobile || '',
                            email: info.email || '',
                            birthday: info.birthday || '',
                            gender: info.gender || ''
                        }
                        
                        // 设置生日日期
                        if (info.birthday) {
                            const date = new Date(info.birthday)
                            birthdayDate.value = [date.getFullYear(), date.getMonth() + 1, date.getDate()]
                        }
                    } catch (error) {
                        console.error('加载用户信息失败:', error)
                    }
                }
                
                // 处理头像上传
                const handleAvatarUpload = (file) => {
                    // 这里实现头像上传逻辑
                    console.log('头像上传:', file)
                    vanToast.success('头像上传成功')
                }
                
                // 生日确认
                const onBirthdayConfirm = ({ selectedValues }) => {
                    const [year, month, day] = selectedValues
                    form.value.birthday = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`
                    showBirthdayPicker.value = false
                }
                
                // 性别确认
                const onGenderConfirm = ({ selectedOptions }) => {
                    form.value.gender = selectedOptions[0].value
                    showGenderPicker.value = false
                }
                
                // 保存修改
                const handleSave = async () => {
                    saving.value = true
                    
                    try {
                        await userStore().updateProfile(form.value)
                        vanToast.success('保存成功')
                        
                        // 重新加载用户信息
                        loadUserInfo()
                    } catch (error) {
                        console.error('保存失败:', error)
                        vanDialog.alert({
                            title: '保存失败',
                            message: error.message || '请稍后重试'
                        })
                    } finally {
                        saving.value = false
                    }
                }
                
                // 初始化加载
                onMounted(() => {
                    loadUserInfo()
                })
                
                return {
                    userInfo,
                    form,
                    avatarFileList,
                    saving,
                    showBirthdayPicker,
                    showGenderPicker,
                    birthdayDate,
                    minDate,
                    maxDate,
                    genderColumns,
                    handleAvatarUpload,
                    onBirthdayConfirm,
                    onGenderConfirm,
                    handleSave
                }
            }
        })
        
        app.component('app-header', window.AppHeader)
        app.mount('#app')
    </script>
</body>
</html>